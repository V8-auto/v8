<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SolidFlow ‚Äî Modern SaaS Dashboard (Mocked API + Settings)</title>
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/favicon-16x16.png"
    />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root {
        --bg: #0f1724;
        --muted: #9aa7b2;
        --accent1: linear-gradient(135deg, #7c3aed 0%, #06b6d4 100%);
        --glass: rgba(255, 255, 255, 0.04);
        --success: #22c55e;
        --warn: #f59e0b;
        --danger: #ef4444;
        --transition: 300ms cubic-bezier(0.2, 0.9, 0.25, 1);
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: radial-gradient(
            1200px 400px at 10% 10%,
            rgba(124, 58, 237, 0.08),
            transparent 8%
          ),
          radial-gradient(
            1000px 300px at 90% 90%,
            rgba(6, 182, 212, 0.06),
            transparent 8%
          ),
          var(--bg);
        color: #e6eef6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        display: flex;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.01)
        );
        border-right: 1px solid rgba(255, 255, 255, 0.03);
        padding: 28px 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        transform: translateX(0);
        transition: var(--transition);
        z-index: 40;
        backdrop-filter: blur(6px) saturate(120%);
      }
      .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: white; /* match sidebar text color */
        display: none; /* hidden by default */
      }
      @media (max-width: 768px) {
        .sidebar.open .close-btn {
          display: block; /* Show only on mobile when sidebar is open */
        }
      }
      .brand {
        display: block;
        gap: 20px;
        align-items: center;
      }
      .menu-toggle {
        display: none;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 20px;
        cursor: pointer;
        padding: 6px 8px;
      }
      .logo {
        height: 80px;
        width: 80px;
        border-radius: 10px;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: white;
        font-size: 18px;
      }
      .brand h1 {
        font-size: 16px;
        margin: 0;
      }
      .brand p {
        margin: 0;
        font-size: 12px;
        color: var(--muted);
      }
      .nav {
        margin-top: 6px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .nav a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        color: #cfe9f7;
        text-decoration: none;
        border-radius: 10px;
        transition: var(--transition);
        font-size: 14px;
      }
      .nav a .ico {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.02);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
      }
      .nav a:hover {
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        transform: translateX(4px);
      }
      .nav a.active {
        background: linear-gradient(
          90deg,
          rgba(124, 58, 237, 0.15),
          rgba(6, 182, 212, 0.06)
        );
        color: #fff;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
      }
      .spacer {
        flex: 1;
      }
      .flex {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      /* App */
      .app {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: auto;
        padding: 28px;
        gap: 18px;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
      }
      /* For phones (up to 576px) */
      @media (max-width: 576px) {
        #welcomeText {
          padding-right: 15px;
        }
      }
      /* Hide by default */
      .mobile-only {
        display: none;
      }

      /* Show on tablets (768px - 1024px) */
      @media (max-width: 1024px) {
        .mobile-only {
          display: block;
        }
      }

      /* Show on mobile (up to 767px) */
      @media (max-width: 767px) {
        .mobile-only {
          display: block;
        }
      }
      /* For tablets (577px to 768px) */
      @media (min-width: 577px) and (max-width: 768px) {
        #welcomeText {
          padding-right: 20px;
        }
      }
      .searchbar {
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--glass);
        padding: 10px 14px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.02);
        width: 520px;
      }
      .searchbar input {
        background: transparent;
        border: 0;
        outline: 0;
        color: inherit;
        width: 100%;
      }
      .actions {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .btn {
        padding: 10px 14px;
        border-radius: 10px;
        border: 0;
        cursor: pointer;
        font-weight: 600;
        display: inline-flex;
        gap: 10px;
        align-items: center;
      }
      .btn.primary {
        background: linear-gradient(90deg, #7c3aed, #06b6d4);
        color: white;
        box-shadow: 0 8px 30px rgba(6, 182, 212, 0.08);
      }
      .btn.ghost {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--muted);
      }
      .kpis {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
        margin-top: 8px;
      }
      .kpi {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        padding: 18px;
        border-radius: 14px;
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        border: 1px solid rgba(255, 255, 255, 0.02);
        transition: transform var(--transition);
      }
      .kpi:hover {
        transform: translateY(-6px);
        box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6);
      }
      .kpi .label {
        color: var(--muted);
        font-size: 13px;
      }
      .kpi .value {
        font-size: 22px;
        font-weight: 700;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 420px;
        gap: 18px;
        margin-top: 18px;
      }
      .panel {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        padding: 18px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.02);
      }
      .panel h3 {
        margin: 0 0 10px 0;
      }
      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      .table thead th {
        text-align: left;
        color: var(--muted);
        padding: 12px 10px;
      }
      .table tbody td {
        padding: 12px 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.02);
      }
      .badge {
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 700;
        font-size: 12px;
      }
      .paid {
        background: rgba(34, 197, 94, 0.12);
        color: var(--success);
      }
      .pending {
        background: rgba(245, 158, 11, 0.12);
        color: var(--warn);
      }
      .overdue {
        background: rgba(239, 68, 68, 0.12);
        color: var(--danger);
      }
      .footer {
        margin-top: 20px;
        color: var(--muted);
        font-size: 13px;
      }
      @media (max-width: 768px) {
        .sidebar.mobile-hidden {
          transform: translateX(-100%);
        }
      }
      /* top-left mobile control */
      .top-left {
        position: fixed;
        left: 16px;
        top: 14px;
        z-index: 60;
      }
      .hambtn {
        width: 46px;
        height: 46px;
        border-radius: 10px;
        background: var(--glass);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.02);
      }
      @media (min-width: 1024px) {
        .hambtn {
          display: none;
        }
        .close-btn {
          display: none;
        }
      }
      /* SETTINGS drawer & profile modal */
      .settings-drawer {
        position: fixed;
        right: -420px;
        top: 0;
        width: 380px;
        height: 100%;
        background: radial-gradient(
            1200px 400px at 10% 10%,
            rgba(124, 58, 237, 0.08),
            transparent 8%
          ),
          radial-gradient(
            1000px 300px at 90% 90%,
            rgba(6, 182, 212, 0.06),
            transparent 8%
          ),
          var(--bg);
        border-left: 1px solid rgba(255, 255, 255, 0.03);
        padding: 20px;
        transition: var(--transition);
        z-index: 60;
        overflow: auto;
      }
      .settings-drawer.open {
        right: 0;
      }
      .profile-modal {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 360px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.01)
        );
        padding: 20px;
        border-radius: 12px;
        transition: var(--transition);
        box-shadow: 0 30px 80px rgba(2, 6, 23, 0.6);
        z-index: 80;
        display: none;
      }
      .profile-modal.open {
        display: block;
        transform: translate(-50%, -50%) scale(1);
      }

      /* responsive */
      @media (max-width: 1100px) {
        .kpis {
          grid-template-columns: repeat(2, 1fr);
        }
        .row {
          grid-template-columns: 1fr 360px;
        }
        .searchbar {
          width: 380px;
        }
      }
      @media (max-width: 820px) {
        .sidebar {
          position: fixed;
          left: 0;
          top: 0;
          height: 100vh;
          transform: translateX(-320px);
        }
        .sidebar.open {
          transform: translateX(0);
        }
        .app {
          padding: 18px;
        }
        .header {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }
        .row {
          grid-template-columns: 1fr;
        }
        .content-shift {
          transform: translateX(0);
        }
        .kpis {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 420px) {
        .kpis {
          grid-template-columns: 1fr;
        }
        .searchbar {
          width: 100%;
        }

        .panel {
          padding: 12px;
        }
        .row {
          grid-template-columns: 1fr;
        }
      }

      /* small helpers */
      .muted {
        color: var(--muted);
      }
      input[type="text"],
      input[type="email"],
      select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        background: transparent;
        color: inherit;
        margin-top: 6px;
      }
      label {
        display: block;
        margin-top: 12px;
        color: var(--muted);
        font-size: 13px;
      }
      .save-row {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 16px;
      }
    </style>
    <style>
      .paid {
        color: #28a745;
        font-weight: bold;
      }
      .pending {
        color: #ffc107;
        font-weight: bold;
      }
      .overdue {
        color: #dc3545;
        font-weight: bold;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        text-align: left;
      }
      tr:hover {
        background: #f1f5fb;
      }
    </style>
    <style>
      .mobile-toggle {
        display: none;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1001;
        background: rgb(1, 1, 41);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 20px;
      }

      .mobile-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }
      @media (max-width: 768px) {
        .mobile-toggle {
          display: block;
        }

        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.mobile-visible {
          transform: translateX(0);
        }

        .mobile-overlay.active {
          display: block;
        }

        .main-content {
          margin-left: 0;
          padding: 80px 15px 15px 15px;
        }

        .invoices-section {
          padding: 20px 15px;
        }

        h1 {
          font-size: 24px;
        }

        .header {
          flex-direction: column;
          align-items: flex-start;
        }

        .header > div {
          width: 100%;
        }

        .btn {
          width: 100%;
        }

        .search-box {
          flex-direction: column;
        }

        .search-box input {
          width: 100%;
          min-width: unset;
        }

        .total-amount {
          font-size: 28px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .chart-card {
          height: auto !important;
        }

        table {
          font-size: 12px;
        }

        th,
        td {
          padding: 8px 6px;
        }

        .edit-btn,
        .delete-btn {
          padding: 4px 8px;
          font-size: 11px;
          display: block;
          width: 100%;
          margin-bottom: 4px;
        }
      }

      .settings-drawer {
        background-color: #1f2130;
        max-width: 500px;
        margin: 0 auto;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      h3 {
        margin-bottom: 24px;
        font-size: 24px;
        color: #333;
      }
      label {
        display: block;
        margin-top: 20px;
        margin-bottom: 8px;
        font-weight: 500;
        color: #555;
        font-size: 14px;
      }
      input[type="text"],
      input[type="email"],
      select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: #4285f4;
      }
      .logo-upload {
        margin-top: 20px;
      }
      .logo-preview {
        margin-top: 12px;
        max-width: 150px;
        max-height: 150px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 10px;
        display: none;
      }
      .logo-preview img {
        width: 100%;
        height: auto;
        border-radius: 4px;
      }
      input[type="file"] {
        padding: 8px 0;
      }
      .save-row {
        margin-top: 30px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }
      .btn {
        padding: 10px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn.ghost {
        background: #f5f5f5;
        color: #666;
      }
      .btn.ghost:hover {
        background: #e8e8e8;
      }
      .btn.primary {
        background: #4285f4;
        color: white;
      }
      .btn.primary:hover {
        background: #3367d6;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .status {
        margin-top: 16px;
        padding: 12px;
        border-radius: 6px;
        font-size: 14px;
        display: none;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
    <!-- Add Chart.js Library -->
  </head>
  <body>
    <button class="mobile-toggle mobile-only" style="background-color: transparent; color: white;" onclick="document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.mobile-overlay').classList.toggle('active');">‚ò∞</button>
    <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>
    <aside id="sidebar" class="sidebar mobile-hidden" aria-hidden="true">
      <button id="closeSidebar" class="close-btn" aria-label="Close menu">
        ‚úï
      </button>
      <div class="brand">
        <div class="logo">
          <img
            src="/assets/img/solidflo-logo.png"
            style="height: 60px"
            alt=""
          />
        </div>
        <div>
          <p class="mini muted">Invoices & Billing</p>
        </div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <a class="active" href="#"
          ><span class="ico">üè†</span><span class="label">Dashboard</span></a
        >
        <a href="/dashboard/invoices.html"
          ><span class="ico">üìÑ</span><span class="label">Invoices</span></a
        >
        <a class="active" href="/dashboard/quotations.html">
          <span class="ico">üìÑ</span><span>Quotations</span>
        </a>
        <a href="/dashboard/clients.html"
          ><span class="ico">üë•</span><span class="label">Clients</span></a
        >
        <a href="/dashboard/payments.html"
          ><span class="ico">üí≥</span><span class="label">Payments</span></a
        >
        <a href="#"
          ><span class="ico">üìä</span><span class="label">Reports</span></a
        >
      </nav>

      <div class="spacer"></div>
      <button
        class="btn ghost"
        style="
          background-color: radial-gradient(
              1200px 400px at 10% 10%,
              rgba(124, 58, 237, 0.08),
              transparent 8%
            ),
            radial-gradient(
              1000px 300px at 90% 90%,
              rgba(6, 182, 212, 0.06),
              transparent 8%
            ),
            var(--bg);
          color: white;
        "
        id="openSettings"
      >
        Settings
      </button>
      <button
        class="btn ghost"
        style="
          background-color: radial-gradient(
              1200px 400px at 10% 10%,
              rgba(124, 58, 237, 0.08),
              transparent 8%
            ),
            radial-gradient(
              1000px 300px at 90% 90%,
              rgba(6, 182, 212, 0.06),
              transparent 8%
            ),
            var(--bg);
          color: white;
        "
        id="logoutBtn"
      >
        Logout
      </button>
     <div class="flex">
        <div
          style="
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.04);
            display: flex;
            align-items: center;
            justify-content: center;
          "
        >
          üë§
        </div>
        <div>
          <div style="font-weight: 700; color: white">User</div>
          <div style="font-size: 12px; color: #9aa7b2">Admin</div>
        </div>
      </div>
    </aside>

    <!-- APP -->
    <div class="app" id="app">
      <!-- mobile hamburger -->

      <header class="header">
        <div
          class="flex"
          style="gap: 18px; align-items: center; padding-top: 50px"
        >
          <div class="searchbar" role="search">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              style="opacity: 0.8"
            >
              <path
                d="M21 21l-4.35-4.35"
                stroke="#a3b9c3"
                stroke-width="1.6"
                stroke-linecap="round"
              />
            </svg>
            <input
              id="searchInput"
              placeholder="Search invoices, clients or IDs..."
              aria-label="Search"
            />
          </div>

          <div class="mini muted" id="welcomeText">
            Welcome back ‚Äî here's your 30 day summary
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="newInvoiceBtn">+ New Invoice</button>
          <button class="btn primary" id="newQuoteBtn">+ New Quote</button>
        </div>
      </header>

      <!-- KPI CARDS -->
      <section class="kpis" aria-label="Key metrics" id="kpis">
        <!-- populated by JS -->
      </section>

      <!-- ROW -->
      <div class="row">
        <div class="panel">
          <h3>Revenue (last 12 months)</h3>
          <canvas id="revChart" style="width: 100%; height: 260px"></canvas>
        </div>

        <div class="panel">
          <h3>Invoice Status</h3>
          <canvas id="statusChart" style="width: 100%; height: 220px"></canvas>
          <div style="margin-top: 12px" class="muted mini">
            Breakdown of paid / pending / overdue
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top: 18px">
        <h3>Recent Invoices</h3>
        <table>
          <thead>
            <tr>
              <th>Invoice #</th>
              <th>Client</th>
              <th>Date</th>
              <th>Total</th>
              <th>Status</th>
              <th style="text-align: center">Actions</th>
            </tr>
          </thead>
          <tbody id="invoicesTableBody">
            <tr>
              <td colspan="6" class="loading">Loading invoices...</td>
            </tr>
          </tbody>
        </table>

        <div class="footer">¬© 2025 SolidFlow ‚Ä¢ Built for quick billing</div>
      </div>
    </div>

    <!-- Settings Drawer -->
    <aside id="settingsDrawer" class="settings-drawer">
      <h3>Settings</h3>

      <label>Business Name</label>
      <input
        type="text"
        id="settingName"
        placeholder="Enter your business name"
      />

      <label>Email</label>
      <input type="email" id="settingEmail" placeholder="Enter your email" />

      <div class="logo-upload">
        <label>Logo</label>
        <input type="file" id="settingLogo" accept="image/*" />
        <div class="logo-preview" id="logoPreview">
          <img id="logoImg" src="" alt="Logo preview" />
        </div>
      </div>

      <label>Currency</label>
      <select id="settingCurrency">
        <option value="USD">USD ($)</option>
        <option value="EUR">EUR (‚Ç¨)</option>
        <option value="ZAR">ZAR (R)</option>
      </select>

      <label>Theme (Local only)</label>
      <select id="settingTheme">
        <option value="modern">Modern SaaS</option>
        <option value="dark">Dark</option>
        <option value="minimal">Minimal</option>
      </select>

      <label>Auto-refresh (seconds)</label>
      <input type="text" id="settingRefresh" value="8" />

      <div class="status" id="statusMsg"></div>

      <div class="save-row">
        <button class="btn ghost" id="cancelSettings">Cancel</button>
        <button class="btn primary" id="saveSettings">Save</button>
      </div>
    </aside>

    <!-- Profile Modal -->
    <div
      id="profileModal"
      class="profile-modal"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
    >
      <h3>Profile</h3>
      <label for="profile_name">Full name</label>
      <input type="text" id="profile_name" value="User" />
      <label for="profile_email">Email</label>
      <input type="email" id="profile_email" value="user@example.com" />
      <label for="profile_role">Role</label>
      <select id="profile_role">
        <option>Admin</option>
        <option>Manager</option>
        <option>Viewer</option>
      </select>

      <div class="save-row">
        <button class="btn ghost" id="closeProfile">Close</button>
        <button class="btn primary" id="saveProfile">Save</button>
      </div>
    </div>

    <script>
      /* -------------------------
   Mock API (simulates latency and evolving data)
   ------------------------- */
      const mockApi = (() => {
        // internal mock state
        let invoices = [
          {
            id: "INV-00123",
            client: "John Carter",
            date: "2025-12-12",
            amount: 620,
            status: "overdue",
          },
          {
            id: "INV-00124",
            client: "Alpha Corp",
            date: "2025-12-12",
            amount: 1200,
            status: "paid",
          },
          {
            id: "INV-00125",
            client: "Mark Tech",
            date: "2025-12-13",
            amount: 460,
            status: "pending",
          },
          {
            id: "INV-00126",
            client: "Sigma Ltd",
            date: "2025-12-14",
            amount: 980,
            status: "paid",
          },
        ];

        let nextIndex = 127;

        function randomDelay(min = 200, max = 700) {
          return Math.floor(Math.random() * (max - min) + min);
        }

        return {
          async fetchDashboard() {
            await new Promise((r) => setTimeout(r, randomDelay()));
            // compute KPIs
            const totalOutstanding = invoices
              .filter((i) => i.status !== "paid")
              .reduce((s, i) => s + i.amount, 0);
            const dueThisWeek = invoices.filter(
              (i) => i.status === "overdue" || i.status === "pending"
            ).length;
            const paymentsThisMonth = invoices
              .filter((i) => i.status === "paid")
              .reduce((s, i) => s + i.amount, 0);
            const totalClients = new Set(invoices.map((i) => i.client)).size;
            // monthly revenue mock
            const months = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ];
            const revenue = months.map((m, i) =>
              Math.round(800 + i * 100 + Math.random() * 300)
            );
            return {
              totalOutstanding,
              dueThisWeek,
              paymentsThisMonth,
              totalClients,
              months,
              revenue,
            };
          },

          async fetchInvoices() {
            await new Promise((r) => setTimeout(r, randomDelay()));
            // return a copy newest-first
            return invoices.slice().reverse();
          },

          // simulate push new invoice occasionally
          simulateNewInvoice() {
            if (Math.random() < 0.55) {
              // ~55% chance per cycle
              const id = `INV-00${nextIndex++}`;
              const amounts = [320, 420, 560, 780, 1500];
              const statuses = ["pending", "paid", "overdue"];
              const invoice = {
                id,
                client: ["Nova Co", "Delta Ltd", "Omega LLC", "Beta Inc"][
                  Math.floor(Math.random() * 4)
                ],
                date: new Date().toISOString().slice(0, 10),
                amount: amounts[Math.floor(Math.random() * amounts.length)],
                status: statuses[Math.floor(Math.random() * statuses.length)],
              };
              // push into invoices
              invoices.push(invoice);
              // keep array manageable
              if (invoices.length > 40) invoices.shift();
              return invoice;
            }
            return null;
          },

          // accept "save settings" and persist in localStorage
          async saveSettings(settings) {
            await new Promise((r) => setTimeout(r, randomDelay()));
            localStorage.setItem(
              "invoicepro_settings",
              JSON.stringify(settings)
            );
            return { ok: true };
            showStatus("Settings saved successfully!", "success");
            displayUserLogo(); // ‚Üê Add this line
            settingsDrawer.classList.remove("open");
          },

          async loadSettings() {
            await new Promise((r) => setTimeout(r, randomDelay()));
            const raw = localStorage.getItem("invoicepro_settings");
            if (raw) return JSON.parse(raw);
            return { theme: "modern", refresh: 8, currency: "USD" };
          },

          async saveProfile(profile) {
            await new Promise((r) => setTimeout(r, randomDelay()));
            localStorage.setItem("invoicepro_profile", JSON.stringify(profile));
            return { ok: true };
          },

          async loadProfile() {
            await new Promise((r) => setTimeout(r, randomDelay()));
            const raw = localStorage.getItem("invoicepro_profile");
            if (raw) return JSON.parse(raw);
            return { name: "User", email: "user@example.com", role: "Admin" };
          },
        };
      })();

      /* -------------------------
   UI: charts, table, periodic poll
   ------------------------- */

      let statusChart;
      const invoicesTbody = document.getElementById("invoicesTbody");
      const kpisContainer = document.getElementById("kpis");

      /* -------------------------
   Settings & Profile logic
   ------------------------- */

      const settingsDrawer = document.getElementById("settingsDrawer");
      const openSettings = document.getElementById("openSettings");
      const cancelSettings = document.getElementById("cancelSettings");
      const saveSettings = document.getElementById("saveSettings");
      const settingTheme = document.getElementById("settingTheme");
      const settingRefresh = document.getElementById("settingRefresh");
      const settingCurrency = document.getElementById("settingCurrency");

      openSettings.addEventListener("click", async () => {
        settingsDrawer.classList.add("open");
        const settings = await mockApi.loadSettings();
        settingTheme.value = settings.theme;
        settingRefresh.value = settings.refresh;
        settingCurrency.value = settings.currency;
        settingsDrawer.setAttribute("aria-hidden", "false");
      });

      cancelSettings.addEventListener("click", () => {
        settingsDrawer.classList.remove("open");
        settingsDrawer.setAttribute("aria-hidden", "true");
      });

      saveSettings.addEventListener("click", async () => {
        const s = {
          theme: settingTheme.value,
          refresh: parseInt(settingRefresh.value) || 8,
          currency: settingCurrency.value,
        };
        await mockApi.saveSettings(s);
        settingsDrawer.classList.remove("open");
        settingsDrawer.setAttribute("aria-hidden", "true");
        console.log("Settings saved", s);
        // apply settings immediately (currency)
        const profile = await mockApi.loadProfile();
        initPeriodicRefresh(s);
        refreshDashboard(s);
      });

      /* Profile modal */
      const profileModal = document.getElementById("profileModal");
      const openProfile = document.getElementById("openProfile");
      const closeProfile = document.getElementById("closeProfile");
      const saveProfile = document.getElementById("saveProfile");
      const profileNameEl = document.getElementById("profile_name");
      const profileEmailEl = document.getElementById("profile_email");
      const profileRoleEl = document.getElementById("profile_role");
      const profileDisplayName = document.getElementById("profileName");
      const profileDisplayRole = document.getElementById("profileRole");

      openProfile.addEventListener("click", async () => {
        const p = await mockApi.loadProfile();
        profileNameEl.value = p.name;
        profileEmailEl.value = p.email;
        profileRoleEl.value = p.role;
        profileModal.classList.add("open");
        profileModal.setAttribute("aria-hidden", "false");
      });

      closeProfile.addEventListener("click", () => {
        profileModal.classList.remove("open");
        profileModal.setAttribute("aria-hidden", "true");
      });

      saveProfile.addEventListener("click", async () => {
        const newP = {
          name: profileNameEl.value,
          email: profileEmailEl.value,
          role: profileRoleEl.value,
        };
        await mockApi.saveProfile(newP);
        profileModal.classList.remove("open");
        profileModal.setAttribute("aria-hidden", "true");
        profileDisplayName.textContent = newP.name;
        profileDisplayRole.textContent = newP.role;
      });

      const settingLogo = document.getElementById("settingLogo");
      const logoPreview = document.getElementById("logoPreview");
      const logoImg = document.getElementById("logoImg");

      // Preview logo when selected
      if (settingLogo) {
        settingLogo.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              logoImg.src = e.target.result;
              logoPreview.style.display = "block";
            };
            reader.readAsDataURL(file);
          }
        });
      }

      // Function to upload and save logo to Firestore subcollection
      async function uploadLogoToCollection(logoFile) {
        const user = firebase.auth().currentUser;
        if (!user) {
          throw new Error("No user logged in");
        }

        try {
          // 1. Upload image to Firebase Storage
          const logoRef = ref(
            storage,
            `users/${user.uid}/logos/logo_${Date.now()}`
          );
          await uploadBytes(logoRef, logoFile);
          const logoUrl = await getDownloadURL(logoRef);

          // 2. Save to Firestore "logo" subcollection
          const logoDocRef = db
            .collection("users")
            .doc(user.uid)
            .collection("logo")
            .doc("current"); // Use "current" as the doc ID for the active logo

          await logoDocRef.set({
            logoUrl: logoUrl,
            fileName: logoFile.name,
            fileSize: logoFile.size,
            fileType: logoFile.type,
            uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
            isActive: true,
          });

          console.log("Logo uploaded successfully:", logoUrl);
          return logoUrl;
        } catch (error) {
          console.error("Error uploading logo:", error);
          throw error;
        }
      }

      // Function to load logo from Firestore subcollection
      async function loadLogoFromCollection() {
        const user = firebase.auth().currentUser;
        if (!user) return;

        try {
          const logoDocRef = db
            .collection("users")
            .doc(user.uid)
            .collection("logo")
            .doc("current");

          const logoDoc = await logoDocRef.get();

          if (logoDoc.exists && logoDoc.data().logoUrl) {
            const logoUrl = logoDoc.data().logoUrl;
            logoImg.src = logoUrl;
            logoPreview.style.display = "block";
            return logoUrl;
          }
        } catch (error) {
          console.error("Error loading logo:", error);
        }
      }
      import { getAuth } from "firebase/auth";
      import { collection, getDocs, query, orderBy } from "firebase/firestore";
      import { db } from "./firebase";

      const invoicesTableBody = document.getElementById("invoicesTableBody");

      async function loadInvoices() {
        const auth = getAuth();
        const user = auth.currentUser;

        if (!user) {
          invoicesTableBody.innerHTML = `
      <tr>
        <td colspan="6">Please log in to view invoices.</td>
      </tr>
    `;
          return;
        }

        try {
          const invoicesRef = collection(db, "users", user.uid, "invoices");
          const q = query(invoicesRef, orderBy("date", "desc"));
          const snapshot = await getDocs(q);

          if (snapshot.empty) {
            invoicesTableBody.innerHTML = `
        <tr>
          <td colspan="6">No invoices found.</td>
        </tr>
      `;
            return;
          }

          invoicesTableBody.innerHTML = "";

          snapshot.forEach((docSnap) => {
            const invoice = docSnap.data();

            invoicesTableBody.insertAdjacentHTML(
              "beforeend",
              `
        <tr>
          <td>${invoice.invoiceNumber}</td>
          <td>${invoice.clientName}</td>
          <td>${formatDate(invoice.date)}</td>
          <td>${formatCurrency(invoice.total)}</td>
          <td>
            <span class="status ${invoice.status}">
              ${invoice.status}
            </span>
          </td>
          <td style="text-align:center">
            <button onclick="viewInvoice('${docSnap.id}')">View</button>
            <button onclick="editInvoice('${docSnap.id}')">Edit</button>
          </td>
        </tr>
        `
            );
          });
        } catch (error) {
          console.error(error);
          invoicesTableBody.innerHTML = `
      <tr>
        <td colspan="6">Failed to load invoices.</td>
      </tr>
    `;
        }
      }
      function viewInvoice(id) {
        console.log("View invoice:", id);
      }

      function editInvoice(id) {
        console.log("Edit invoice:", id);
      }

      // Add to your existing saveSettings button click handler
      // Replace the logo upload section with this:
      saveSettings.addEventListener("click", async () => {
        const user = firebase.auth().currentUser;
        if (!user) {
          showStatus("Please log in first", "error");
          return;
        }

        saveSettings.disabled = true;
        saveSettings.textContent = "Saving...";

        try {
          // Upload logo if selected
          const logoFile = settingLogo.files[0];
          let logoUrl = null;

          if (logoFile) {
            logoUrl = await uploadLogoToCollection(logoFile);
          }

          // Also save logo URL to main user document for easy access
          const userDocRef = db.collection("users").doc(user.uid);
          await userDocRef.set(
            {
              name: settingName.value,
              email: settingEmail.value,
              currency: settingCurrency.value,
              autoRefresh: settingRefresh.value,
              logoUrl: logoUrl, // Save logo URL here too
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            },
            { merge: true }
          );

          showStatus("Settings saved successfully!", "success");
          settingsDrawer.classList.remove("open");
        } catch (error) {
          console.error("Error saving settings:", error);
          showStatus("Error: " + error.message, "error");
        } finally {
          saveSettings.disabled = false;
          saveSettings.textContent = "Save";
        }
      });

      // Load logo when opening settings
      openSettings.addEventListener("click", async () => {
        await loadLogoFromCollection();
        settingsDrawer.classList.add("open");
      });

      // Initialize the logo subcollection (run once during user setup)
      async function initializeLogoCollection() {
        const user = firebase.auth().currentUser;
        if (!user) return;

        const batch = db.batch();

        const logoInitRef = db
          .collection("users")
          .doc(user.uid)
          .collection("logo")
          .doc("_init");

        batch.set(logoInitRef, {
          _placeholder: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        await batch.commit();
        console.log("Logo collection initialized");
      }
      function loadUserProfile(user) {
  db.collection("users").doc(user.uid).get()
    .then((doc) => {
      if (doc.exists) {
        const userData = doc.data();
        // Update profile display if you have these elements
        const profileName = document.querySelector('.flex div:last-child div:first-child');
        const profileRole = document.querySelector('.flex div:last-child div:last-child');
        
        if (profileName) {
          profileName.textContent = userData.name || 'User';
        }
        if (profileRole) {
          profileRole.textContent = (userData.role || 'user').charAt(0).toUpperCase() + (userData.role || 'user').slice(1);
        }
      }
    })
    .catch((error) => {
      console.error("Error loading profile:", error);
    });
}
      async function displayUserLogo() {
        const user = firebase.auth().currentUser;
        if (!user) return;

        try {
          // First try to get from logo subcollection
          const logoDocRef = db
            .collection("users")
            .doc(user.uid)
            .collection("logo")
            .doc("current");

          const logoDoc = await logoDocRef.get();
          let logoUrl = null;

          if (logoDoc.exists && logoDoc.data().logoUrl) {
            logoUrl = logoDoc.data().logoUrl;
          } else {
            // Fallback: try to get from main user document
            const userDocRef = db.collection("users").doc(user.uid);
            const userDoc = await userDocRef.get();

            if (userDoc.exists() && userDoc.data().logoUrl) {
              logoUrl = userDoc.data().logoUrl;
            }
          }

          // Update logo in the page
          if (logoUrl) {
            const logoImg = document.querySelector(".logo img");
            if (logoImg) {
              logoImg.src = logoUrl;
              logoImg.style.height = "60px";
              logoImg.onerror = function () {
                // If uploaded logo fails to load, revert to default
                this.src = "/assets/img/solidflo-logo.png";
              };
            }
          }
        } catch (error) {
          console.error("Error displaying logo:", error);
        }
      }

      // Call this when user logs in or page loads
      firebase.auth().onAuthStateChanged((user) => {
        if (user && user.emailVerified) {
          displayUserLogo();
        }
      });
      /* -------------------------
   Polling / live updates
   ------------------------- */
      let pollIntervalId = null;
      async function initPeriodicRefresh(settings) {
        if (pollIntervalId) clearInterval(pollIntervalId);
        const cfg = settings || (await mockApi.loadSettings());
        const every = (cfg.refresh || 8) * 1000;
        // initial run
        await refreshDashboard(cfg);
        // set interval
        pollIntervalId = setInterval(async () => {
          // simulate push
          const newInv = mockApi.simulateNewInvoice();
          if (newInv) {
            // show small transient toast (console for now)
            console.log("New invoice pushed:", newInv);
          }
          await refreshDashboard(cfg);
        }, every);
      }

      /* -------------------------
   Sidebar mobile toggle and click-out
   ------------------------- */
      const sidebarEl = document.getElementById("sidebar");
      const hambtn = document.getElementById("hambtn");
      const closeBtn = document.getElementById("closeSidebar");
      hambtn.addEventListener("click", () =>{
  sidebarEl.classList.toggle("open");
  document.querySelector(".mobile-overlay").classList.toggle("active");
});
    closeBtn.addEventListener("click", () => {
      sidebarEl.classList.remove("open");
      sidebarEl.setAttribute("aria-hidden", "true");
      document.querySelector(".mobile-overlay").classList.remove("active");
    });
      document.addEventListener("click", (e) => {
        if (window.innerWidth <= 820) {
          const inside =
            sidebarEl.contains(e.target) ||
            hambtn.contains(e.target) ||
            document.getElementById("settingsDrawer").contains(e.target);
          if (!inside) sidebarEl.classList.remove("open");
        }
      });

      /* -------------------------
   Initialize
   ------------------------- */
      (async function init() {
        await initCharts();
        // load profile into UI header
        const p = await mockApi.loadProfile();
        profileDisplayName.textContent = p.name;
        profileDisplayRole.textContent = p.role;
        // start refresh based on settings
        const settings = await mockApi.loadSettings();
        initPeriodicRefresh(settings);
      })();

      /* -------------------------
   Utility: simple new invoice button
   ------------------------- */
      document
        .getElementById("newInvoiceBtn")
        .addEventListener("click", async () => {
          window.location.href = "invoice.html";
        });
      document
        .getElementById("newQuoteBtn")
        .addEventListener("click", async () => {
          window.location.href = "quote.html";
        });
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
      function toggleMobileMenu() {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.querySelector(".mobile-overlay");

        sidebar.classList.toggle("mobile-visible");
        sidebar.classList.toggle("mobile-hidden");
        overlay.classList.toggle("active");
      }
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
      // Initialize Firebase
      let firebaseReady = false;

      const firebaseConfig = {
        apiKey: "AIzaSyD1Xzk2DL-kuxEMgbomupgAF0IQZWso8PQ",
        authDomain: "solidflow-1f753.firebaseapp.com",
        projectId: "solidflow-1f753",
        storageBucket: "solidflow-1f753.firebasestorage.app",
        messagingSenderId: "68885400864",
        appId: "1:68885400864:web:7788e19a073d9a8e79db45",
        measurementId: "G-RTL0CM1B44",
      };

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      firebaseReady = true;
      function getCurrentUserId() {
        const user = firebase.auth().currentUser;
        if (!user) {
          throw new Error("No user logged in");
        }
        return user.uid;
      }
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      const storage = getStorage(app);

      // Replace with actual user ID (from auth or session)
      const userId = "user_123";

      const elements = {
        name: document.getElementById("settingName"),
        email: document.getElementById("settingEmail"),
        logo: document.getElementById("settingLogo"),
        logoPreview: document.getElementById("logoPreview"),
        logoImg: document.getElementById("logoImg"),
        currency: document.getElementById("settingCurrency"),
        theme: document.getElementById("settingTheme"),
        refresh: document.getElementById("settingRefresh"),
        saveBtn: document.getElementById("saveSettings"),
        cancelBtn: document.getElementById("cancelSettings"),
        status: document.getElementById("statusMsg"),
      };

      // Show status message
      function showStatus(message, type) {
        elements.status.textContent = message;
        elements.status.className = `status ${type}`;
        elements.status.style.display = "block";
        setTimeout(() => {
          elements.status.style.display = "none";
        }, 3000);
      }

      // Preview logo
      elements.logo.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            elements.logoImg.src = e.target.result;
            elements.logoPreview.style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      });

      // Load settings
      async function loadSettings() {
        try {
          const docRef = doc(db, "users", userId);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            const data = docSnap.data();
            elements.name.value = data.name || "";
            elements.email.value = data.email || "";
            elements.currency.value = data.currency || "USD";
            elements.refresh.value = data.autoRefresh || "8";

            if (data.logoUrl) {
              elements.logoImg.src = data.logoUrl;
              elements.logoPreview.style.display = "block";
            }
          }

          // Load theme from localStorage
          const theme = localStorage.getItem("theme") || "modern";
          elements.theme.value = theme;
        } catch (error) {
          console.error("Error loading settings:", error);
          showStatus("Error loading settings", "error");
        }
      }

      // Save settings
      elements.saveBtn.addEventListener("click", async () => {
        elements.saveBtn.disabled = true;
        elements.saveBtn.textContent = "Saving...";

        try {
          const settingsData = {
            name: elements.name.value,
            email: elements.email.value,
            currency: elements.currency.value,
            autoRefresh: elements.refresh.value,
            updatedAt: new Date().toISOString(),
          };

          // Upload logo if selected
          const logoFile = elements.logo.files[0];
          if (logoFile) {
            const logoRef = ref(storage, `users/${userId}/logo_${Date.now()}`);
            await uploadBytes(logoRef, logoFile);
            const logoUrl = await getDownloadURL(logoRef);
            settingsData.logoUrl = logoUrl;
          }

          // Save to Firestore
          await setDoc(doc(db, "users", userId), settingsData, { merge: true });

          // Save theme to localStorage only
          localStorage.setItem("theme", elements.theme.value);

          showStatus("Settings saved successfully!", "success");
        } catch (error) {
          console.error("Error saving settings:", error);
          showStatus("Error saving settings: " + error.message, "error");
        } finally {
          elements.saveBtn.disabled = false;
          elements.saveBtn.textContent = "Save";
        }
      });

      // Cancel
      elements.cancelBtn.addEventListener("click", () => {
        loadSettings();
        showStatus("Changes discarded", "error");
      });

      // Load settings on page load
      loadSettings();
      // Fetch all invoices
      async function fetchAllInvoices() {
        if (!firebaseReady) return [];

        try {
          // Get current user
          const user = firebase.auth().currentUser;

          if (!user) {
            console.error("No user logged in");
            return [];
          }

          const db = firebase.firestore();

          // Fetch from user's invoices subcollection
          const snapshot = await db
            .collection("users")
            .doc(user.uid)
            .collection("invoices")
            .orderBy("createdAt", "desc")
            .get();

          const invoices = [];
          snapshot.forEach((doc) => {
            invoices.push({
              id: doc.id,
              ...doc.data(),
            });
          });

          return invoices;
        } catch (error) {
          console.error("Error fetching invoices:", error);
          return [];
        }
      }
      async function displayUserInfo() {
        const user = firebase.auth().currentUser;
        if (!user) return;

        try {
          const userDocRef = db.collection("users").doc(user.uid);
          const userDoc = await userDocRef.get();

          if (userDoc.exists()) {
            const userData = userDoc.data();

            // Display company name (or fallback to user name or email)
            const displayName =
              userData.name || userData.companyName || user.email.split("@")[0];
            document.getElementById("profileName").textContent = displayName;

            // Display role
            const role = userData.role || "Admin";
            document.getElementById("profileRole").textContent = role;
          } else {
            // Fallback if no user document exists
            document.getElementById("profileName").textContent =
              user.email.split("@")[0];
            document.getElementById("profileRole").textContent = "Admin";
          }
        } catch (error) {
          console.error("Error loading user info:", error);
          document.getElementById("profileName").textContent = "User";
          document.getElementById("profileRole").textContent = "Admin";
        }
      }
      firebase.auth().onAuthStateChanged((user) => {
        if (user && user.emailVerified) {
          displayUserInfo();
          displayUserLogo();
        }
      });
      // Display invoices in table
      async function displayInvoicesTable() {
        const invoices = await fetchAllInvoices();
        const tableBody = document.getElementById("invoicesTableBody");

        if (invoices.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #666;">No invoices found</td></tr>';
          return;
        }

        tableBody.innerHTML = invoices
          .map(
            (invoice) => `
        <tr style="cursor: pointer;" onclick="openInvoice('${
          invoice.invoiceNumber
        }')">
          <td>${invoice.invoiceNumber}</td>
          <td>${invoice.clientName || "N/A"}</td>
          <td>${invoice.issueDate || "N/A"}</td>
          <td>${invoice.total || "R 0.00"}</td>
          <td><span class="status-badge status-saved">Saved</span></td>
          <td style="text-align: center;">
            <button class="btn btn-primary" onclick="event.stopPropagation(); openInvoice('${
              invoice.invoiceNumber
            }')">
              View
            </button>
          </td>
        </tr>
      `
          )
          .join("");
      }

      // Open invoice in invoice page
      function openInvoice(invoiceNumber) {
        // Store invoice number in sessionStorage
        sessionStorage.setItem("loadInvoiceNumber", invoiceNumber);

        // Redirect to invoice page
        window.location.href = "/dashboard/invoice.html";
      }

      // Search functionality
      let allInvoices = [];
      async function handleSearch() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();

        if (!allInvoices.length) {
          allInvoices = await fetchAllInvoices();
        }

        const filtered = allInvoices.filter(
          (invoice) =>
            invoice.invoiceNumber.toLowerCase().includes(searchTerm) ||
            (invoice.clientName &&
              invoice.clientName.toLowerCase().includes(searchTerm))
        );

        const tableBody = document.getElementById("invoicesTableBody");

        if (filtered.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #666;">No matching invoices found</td></tr>';
          return;
        }

        tableBody.innerHTML = filtered
          .map(
            (invoice) => `
        <tr style="cursor: pointer;" onclick="openInvoice('${
          invoice.invoiceNumber
        }')">
          <td>${invoice.invoiceNumber}</td>
          <td>${invoice.clientName || "N/A"}</td>
          <td>${invoice.issueDate || "N/A"}</td>
          <td>${invoice.total || "R 0.00"}</td>
          <td><span class="status-badge status-saved">Saved</span></td>
          <td style="text-align: center;">
            <button class="btn btn-primary" onclick="event.stopPropagation(); openInvoice('${
              invoice.invoiceNumber
            }')">
              View
            </button>
          </td>
        </tr>
      `
          )
          .join("");
      }

      // Load invoices on page load
      document.addEventListener("DOMContentLoaded", () => {
        displayInvoicesTable();
      });
      document.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        return false;
      });

      // Disable keyboard shortcuts (optional - prevents Ctrl+S, Ctrl+U, etc.)
      document.addEventListener("keydown", (e) => {
        // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
        if (
          e.keyCode === 123 || // F12
          (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
          (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
          (e.ctrlKey && e.keyCode === 85)
        ) {
          // Ctrl+U
          e.preventDefault();
          return false;
        }
      });
    </script>
    <script>
      const auth = firebase.auth();
      const db = firebase.firestore();

      // Check authentication and get user data
   auth.onAuthStateChanged((user) => {
  if (user && user.emailVerified) {
    currentUserId = user.uid;
    firebaseReady = true;
    
    // Load user profile
    loadUserProfile(user);
    
    // Load invoices
    displayInvoicesTable();
  } else {
    // Redirect to login if not authenticated
    window.location.href = "/login.html";
  }
});
      const logoutBtn = document.getElementById("logoutBtn");

      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          try {
            // Disable button during logout
            logoutBtn.disabled = true;
            logoutBtn.textContent = "Logging out...";

            // Sign out from Firebase
            await firebase.auth().signOut();

            // Clear any localStorage data (optional)
            // localStorage.clear(); // Uncomment if you want to clear all local data

            // Redirect to login page
            window.location.href = "/login.html";
          } catch (error) {
            console.error("Error logging out:", error);
            alert("Error logging out. Please try again.");

            // Re-enable button if error
            logoutBtn.disabled = false;
            logoutBtn.textContent = "Logout";
          }
        });
      }
    </script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      async function loadClientLogo(userId, clientId) {
        try {
          const clientDocRef = doc(db, "users", userId, "clients", clientId);
          const clientDoc = await getDoc(clientDocRef);

          if (clientDoc.exists() && clientDoc.data().logoURL) {
            document.getElementById("brandLogo").src = clientDoc.data().logoURL;
          }
        } catch (error) {
          console.error("Error loading logo:", error);
        }
      }

      // Example: Load logo for current user's own client record
      auth.onAuthStateChanged((user) => {
        if (user) {
          loadClientLogo(user.uid, user.uid);

          // OR if you have a specific client ID from quote/invoice data:
          // const clientId = 'client123'; // from your quote/invoice data
          // loadClientLogo(user.uid, clientId);
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  </body>
</html>
