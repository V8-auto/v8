<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invoice Viewer & Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: #0f1724;
      }
      .main-container {
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      .sidebar {
        width: 260px;
        background: #0f1724;
        border-right: 1px solid rgba(255, 255, 255, 0.03);
        padding: 28px 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .content-area {
        flex: 1;
        overflow-y: auto;
        background: #f9fafb;
      }
      .nav {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .nav a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        color: #cfe9f7;
        text-decoration: none;
        border-radius: 10px;
        font-size: 14px;
      }
      .nav a:hover {
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: 0.3s;
        width: 100%;
        margin-top: 5px;
      }
      .btn-primary {
        background: #d32f2f;
        color: white;
      }
      .btn-secondary {
        background: #333;
        color: white;
      }
      .spacer {
        flex: 1;
      }

      @media print {
        body {
          background: white;
        }
        .sidebar,
        .no-print {
          display: none !important;
        }
        .content-area {
          background: white;
        }
        .print-area {
          padding: 15mm 10mm;
        }
        @page {
          size: A4 portrait;
          margin: 15mm;
        }
        .invoice-container {
          width: 210mm !important;
          max-width: 210mm !important;
          margin: 0 auto !important;
          padding: 0 !important;
        }
        .invoice-preview {
          width: 100% !important;
          max-width: 100% !important;
          margin: 0 !important;
          padding: 20mm 15mm !important;
          box-shadow: none !important;
        }
        .overflow-y-auto {
          width: 100% !important;
          overflow: visible !important;
        }
        .resizer-handle {
          display: none !important;
        }
        .max-w-7xl {
          max-width: 100% !important;
        }
      }
      .invoice-container {
        width: 210mm !important;
        max-width: 210mm !important;
        min-width: 210mm !important;
      }

      .invoice-preview {
        width: 100% !important;
      }

      /* Print wrapper takes full width on print */
      @media print {
        .print-invoice-wrapper {
          width: 100% !important;
          display: flex !important;
          justify-content: center !important;
        }
      }
      /* Mobile Sidebar Styles */
      .mobile-sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        width: 300px;
        height: 100vh;
        background: white;
        z-index: 1000;
        transition: left 0.3s ease;
        overflow-y: auto;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }
      .mobile-sidebar.open {
        left: 0;
      }
      .mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }
      .mobile-overlay.open {
        display: block;
      }
      @media (min-width: 1024px) {
        .mobile-sidebar {
          position: static;
          width: auto;
          height: auto;
          box-shadow: none;
        }
        .mobile-overlay {
          display: none !important;
        }
        .hamburger-menu {
          display: none !important;
        }
      }
      @media (max-width: 640px) {
        .sidebar {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <aside class="sidebar">
        <div style="padding: 20px">
          <div
            style="
              width: 60px;
              height: 60px;
              background: transparent;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <img
              src="/assets/img/solidflo-logo.png"
              style="height: 60px"
              alt=""
            />
          </div>
          <p style="color: #9aa7b2; font-size: 12px; margin-top: 10px">
            Quotations & Billing
          </p>
        </div>

        <nav class="nav" style="padding: 20px">
          <a href="/dashboard/index.html"
            ><span>üè†</span><span>Dashboard</span></a
          >
          <a href="/dashboard/invoices.html"
            ><span>üìÑ</span><span>Invoices</span></a
          >
          <a href="/dashboard/quotations.html"
            ><span>üìÑ</span><span>Quotations</span></a
          >
          <a href="/dashboard/clients.html"
            ><span>üë•</span><span>Clients</span></a
          >
          <a href="/dashboard/payments.html"
            ><span>üí≥</span><span>Payments</span></a
          >
          <a href="/dashboard/templates.html"
            ><span>üí≥</span><span>Templates</span></a
          >
          <button class="btn btn-primary" onclick="window.print()">
            üñ®Ô∏è Print / Save PDF
          </button>
          <button class="btn btn-secondary" onclick="window.history.back()">
            ‚Üê Back
          </button>
        </nav>

        <div class="spacer"></div>

        <div style="display: flex; gap: 10px; padding: 20px" id="userDisplay">
          <div
            style="
              width: 44px;
              height: 44px;
              border-radius: 10px;
              background: rgba(255, 255, 255, 0.04);
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            üë§
          </div>
          <div>
            <div style="font-weight: 700; color: white" id="userName">User</div>          </div>
        </div>
      </aside>

      <div class="content-area" id="root"></div>
    </div>

    <script type="text/babel">
      const { useState, useRef, useEffect } = React;

      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyD1Xzk2DL-kuxEMgbomupgAF0IQZWso8PQ",
        authDomain: "solidflow-1f753.firebaseapp.com",
        projectId: "solidflow-1f753",
        storageBucket: "solidflow-1f753.firebasestorage.app",
        messagingSenderId: "68885400864",
        appId: "1:68885400864:web:7788e19a073d9a8e79db45",
        measurementId: "G-RTL0CM1B44",
      };

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const auth = firebase.auth();
      const db = firebase.firestore();
      const InvoiceDisplay = ({ invoiceData, userId, styles, branding }) => {
        if (!invoiceData) {
          return (
            <div className="flex items-center justify-center h-64">
              <div className="text-gray-600">No invoice data</div>
            </div>
          );
        }

        return (
          <div
            className="invoice-container mx-auto"
            style={{ width: "210mm", maxWidth: "210mm", minWidth: "210mm" }}
          >
            <div className="invoice-preview w-full mx-auto p-8 bg-white shadow-lg rounded-lg">
              {/* Header with template styling */}
              <div
                className={`${styles?.headerBg || "bg-gray-100"} ${
                  styles?.headerBorder || "border-b-2"
                } p-6 mb-6`}
              >
                {branding?.logo && (
                  <img src={branding.logo} alt="Logo" className="h-16 mb-4" />
                )}
                <h1 className={`${styles?.titleSize || "text-4xl"} font-bold`}>
                  INVOICE
                </h1>
                {branding?.tagline && (
                  <p className="text-sm text-gray-600 mt-2">
                    {branding.tagline}
                  </p>
                )}
              </div>

              {/* Invoice Details */}
              <div className="grid grid-cols-2 gap-6 mb-6">
                <div>
                  <h3
                    className={`${
                      styles?.sectionTitle || "font-semibold"
                    } mb-2`}
                  >
                    From:
                  </h3>
                  <p className="font-semibold">{invoiceData.from?.name}</p>
                  <p>{invoiceData.from?.address}</p>
                  <p>{invoiceData.from?.city}</p>
                  <p>{invoiceData.from?.email}</p>
                  <p>{invoiceData.from?.phone}</p>
                </div>

                <div>
                  <h3
                    className={`${
                      styles?.sectionTitle || "font-semibold"
                    } mb-2`}
                  >
                    To:
                  </h3>
                  <p className="font-semibold">{invoiceData.to?.name}</p>
                  <p>{invoiceData.to?.address}</p>
                  <p>{invoiceData.to?.city}</p>
                  <p>{invoiceData.to?.email}</p>
                  <p>{invoiceData.to?.phone}</p>
                </div>
              </div>

              {/* Invoice Info */}
              <div className="grid grid-cols-3 gap-4 mb-6">
                <div>
                  <p className="text-gray-600">Invoice Number</p>
                  <p className="font-semibold">{invoiceData.number}</p>
                </div>
                <div>
                  <p className="text-gray-600">Date</p>
                  <p className="font-semibold">{invoiceData.date}</p>
                </div>
                <div>
                  <p className="text-gray-600">Due Date</p>
                  <p className="font-semibold">{invoiceData.dueDate}</p>
                </div>
              </div>

              {/* Vehicle Info */}
              {invoiceData.vehicle && (
                <div
                  className={`${
                    styles?.cardBg || "bg-gray-50"
                  } p-4 rounded mb-6`}
                >
                  <h3
                    className={`${
                      styles?.sectionTitle || "font-semibold"
                    } mb-2`}
                  >
                    Vehicle Details:
                  </h3>
                  <div className="grid grid-cols-2 gap-2 text-sm">
                    <p>
                      <span className="font-semibold">Registration:</span>{" "}
                      {invoiceData.vehicle.registration}
                    </p>
                    <p>
                      <span className="font-semibold">Make/Model:</span>{" "}
                      {invoiceData.vehicle.make} {invoiceData.vehicle.model}
                    </p>
                    <p>
                      <span className="font-semibold">Engine:</span>{" "}
                      {invoiceData.vehicle.engine}
                    </p>
                    <p>
                      <span className="font-semibold">VIN:</span>{" "}
                      {invoiceData.vehicle.vin}
                    </p>
                    <p>
                      <span className="font-semibold">Odometer:</span>{" "}
                      {invoiceData.vehicle.odometer}
                    </p>
                  </div>
                </div>
              )}

              {/* Items Table */}
              <div className="w-full overflow-x-auto mb-6">
                <table className={`w-full ${styles?.tableBorder || "border"}`}>
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="text-left p-3">Description</th>
                      <th className="text-center p-3">Quantity</th>
                      <th className="text-right p-3">Rate</th>
                      <th className="text-right p-3">Amount</th>
                    </tr>
                  </thead>
                  <tbody>
                    {invoiceData.items?.map((item, index) => (
                      <tr key={index} className="border-t">
                        <td className="p-3">{item.description}</td>
                        <td className="text-center p-3">{item.quantity}</td>
                        <td className="text-right p-3">
                          R {item.rate?.toFixed(2)}
                        </td>
                        <td className="text-right p-3">
                          R {item.amount?.toFixed(2)}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Total */}
              <div className="flex justify-end mb-6">
                <div className="w-64">
                  <div className="flex justify-between py-2 border-t-2 border-gray-800 font-bold text-lg">
                    <span>Total:</span>
                    <span>
                      R{" "}
                      {invoiceData.items
                        ?.reduce((sum, item) => sum + (item.amount || 0), 0)
                        .toFixed(2)}
                    </span>
                  </div>
                </div>
              </div>

              {/* Notes */}
              {invoiceData.notes && (
                <div className="border-t pt-4">
                  <p className="text-sm text-gray-600">{invoiceData.notes}</p>
                </div>
              )}
            </div>
          </div>
        );
      };

      const InvoiceManager = () => {
        const [activeTab, setActiveTab] = useState("editor");
        const [sidebarOpen, setSidebarOpen] = useState(false);
        const [user, setUser] = useState(null);
        const [userProfile, setUserProfile] = useState({
          name: "User",
          role: "Admin",
        });
        const [invoiceTemplate, setInvoiceTemplate] = useState(null);
        const [invoices, setInvoices] = useState([]);
        const [template, setTemplates] = useState([]);
        const [selectedInvoiceId, setSelectedInvoiceId] = useState("");
        const [savedTemplates, setSavedTemplates] = useState([]);
        const [purchasedTemplates, setPurchasedTemplates] = useState([]);
        const [selectedTemplate, setSelectedTemplate] = useState("null");
        const [currentTemplateStyles, setCurrentTemplateStyles] =
          useState(null);
        const [loading, setLoading] = useState(true);
        const [branding, setBranding] = useState({
          logo: null,
          primaryColor: "#3B82F6",
          companyName: "Your Business Ltd",
          tagline: "Professional Services",
          font: "Inter, system-ui, sans-serif",
        });

        const [invoiceData, setInvoiceData] = useState({
          number: "",
          date: "",
          dueDate: "",
          serviceType: "SERVICE",
          merchantCode: "",
          from: {
            name: "",
            address: "",
            city: "",
            email: "",
            phone: "",
          },
          to: {
            name: "",
            address: "",
            city: "",
            email: "",
            phone: "",
          },
          vehicle: {
            registration: "",
            make: "",
            model: "",
            engine: "",
            vin: "",
            odometer: "",
          },
          items: [],
          notes: "",
        });
        useEffect(() => {
          const unsubscribe = auth.onAuthStateChanged(async (user) => {
            setUser(user);

            if (!user) {
              window.location.href = "/login.html";
              return;
            }

            if (!user.emailVerified) {
              window.location.href = "/login.html";
              return;
            }

            // Load data
            await Promise.all([
              loadInvoices(user.uid),
              loadTemplates(user.uid),
            ]);

            setLoading(false);
          });

          return () => unsubscribe();
        }, []);
        const loadInvoices = async (userId) => {
          try {
            const snapshot = await db
              .collection("users")
              .doc(userId)
              .collection("invoices")
              .get();

            const invoicesData = [];
            snapshot.forEach((doc) => {
              invoicesData.push({
                id: doc.id,
                ...doc.data(),
              });
            });

            setInvoices(invoicesData);

            // Set first invoice as default
            if (invoicesData.length > 0) {
              setSelectedInvoiceId(invoicesData[0].id);
            }
          } catch (error) {
            console.error("Error loading invoices:", error);
          }
        };
        const loadTemplates = async (userId) => {
          try {
            const snapshot = await db
              .collection("users")
              .doc(userId)
              .collection("invoiceTemplates")
              .get();

            const templatesData = [];
            snapshot.forEach((doc) => {
              templatesData.push({
                id: doc.id,
                ...doc.data(),
              });
            });

            setTemplates(templatesData);

            // Set first template as default
            if (templatesData.length > 0) {
              setSelectedTemplateId(templatesData[0].id);
              loadAndApplyTemplate(templatesData[0].id, userId);
            }
          } catch (error) {
            console.error("Error loading templates:", error);
          }
        };
        const loadInvoiceData = async (invoiceId) => {
          try {
            setLoading(true);
            const doc = await db
              .collection("users")
              .doc(user.uid)
              .collection("invoicesTemplates")
              .doc(invoiceId)
              .get();

            if (doc.exists) {
              setInvoiceData(doc.data());
            } else {
              console.log("No invoice found");
            }
          } catch (error) {
            console.error("Error loading invoice:", error);
          } finally {
            setLoading(false);
          }
        };
        const [sections, setSections] = useState([
          { id: "header", name: "Header", visible: true },
          { id: "client", name: "Client Info", visible: true },
          { id: "vehicle", name: "Vehicle Details", visible: true },
          { id: "items", name: "Line Items", visible: true },
          { id: "totals", name: "Totals", visible: true },
          { id: "notes", name: "Notes", visible: true },
        ]);

        const [draggedSection, setDraggedSection] = useState(null);
        const [leftWidth, setLeftWidth] = useState(66.67); // Start at 2/3 width (66.67%)
        const [isResizing, setIsResizing] = useState(false);
        const containerRef = useRef(null);

        const handleMouseDown = (e) => {
          e.preventDefault();
          setIsResizing(true);
        };
        const signInWithEmail = async (email, password) => {
          try {
            await auth.signInWithEmailAndPassword(email, password);
            setShowAuthModal(false);
          } catch (error) {
            alert("Login failed: " + error.message);
          }
        };

        const signUpWithEmail = async (email, password) => {
          try {
            await auth.createUserWithEmailAndPassword(email, password);
            setShowAuthModal(false);
          } catch (error) {
            alert("Sign up failed: " + error.message);
          }
        };

        const signOut = async () => {
          try {
            await auth.signOut();
            setSavedTemplates([]);
          } catch (error) {
            alert("Sign out failed: " + error.message);
          }
        };
        useEffect(() => {
          const handleMouseMove = (e) => {
            if (!isResizing || !containerRef.current) return;

            const container = containerRef.current;
            const containerRect = container.getBoundingClientRect();
            const newLeftWidth =
              ((e.clientX - containerRect.left) / containerRect.width) * 100;

            // Limit between 30% and 80%
            if (newLeftWidth >= 60 && newLeftWidth <= 80) {
              setLeftWidth(newLeftWidth);
            }
          };

          const handleMouseUp = () => {
            setIsResizing(false);
            document.body.style.cursor = '';
          };

          if (isResizing) {
            document.body.style.cursor = 'col-resize'; 
            document.addEventListener("mousemove", handleMouseMove);
            document.addEventListener("mouseup", handleMouseUp);
          }

          return () => {
            document.body.style.cursor = '';
            document.removeEventListener("mousemove", handleMouseMove);
            document.removeEventListener("mouseup", handleMouseUp);
          };
        }, [isResizing]);

        const templates = [
          {
            id: "modern",
            name: "Modern",
            description: "Clean, minimalist design",
            icon: "üìÑ",
            price: 9.99,
          },
          {
            id: "classic",
            name: "Classic",
            description: "Traditional business style",
            icon: "üìã",
            price: 9.99,
          },
          {
            id: "creative",
            name: "Creative",
            description: "Bold and colorful",
            icon: "üé®",
            price: 14.99,
          },
          {
            id: "corporate",
            name: "Corporate",
            description: "Professional enterprise look",
            icon: "üè¢",
            price: 14.99,
          },
        ];
        const allTemplates = [
          {
            id: "modern",
            name: "Modern",
            description: "Clean, minimalist design",
            icon: "üìÑ",
            isPremium: false,
          },
          {
            id: "classic",
            name: "Classic",
            description: "Traditional business style",
            icon: "üìã",
            isPremium: true,
          },
          {
            id: "creative",
            name: "Creative",
            description: "Bold and colorful",
            icon: "üé®",
            isPremium: true,
          },
          {
            id: "corporate",
            name: "Corporate",
            description: "Professional enterprise look",
            icon: "üè¢",
            isPremium: true,
          },
          {
            id: "minimal",
            name: "Minimal",
            description: "Ultra-clean layout",
            icon: "‚ö™",
            isPremium: true,
          },
          {
            id: "elegant",
            name: "Elegant",
            description: "Sophisticated design",
            icon: "‚ú®",
            isPremium: true,
          },
        ];
        const loadUserProfile = async (user) => {
          try {
            const doc = await db.collection("users").doc(user.uid).get();

            if (doc.exists) {
              const userData = doc.data();
              setUserProfile({
                name: userData.name || "User",
                role: userData.role
                  ? userData.role.charAt(0).toUpperCase() +
                    userData.role.slice(1)
                  : "User",
              });
            }
          } catch (error) {
            console.error("Error loading profile:", error);
          }
        };

        // If keeping it in static sidebar outside React
        useEffect(() => {
          if (userProfile.name !== "User") {
            const profileName = document.getElementById("userName");
            if (profileName) {
              profileName.textContent = userProfile.name;
            }
          }
        }, [userProfile]);
        useEffect(() => {
          const unsubscribe = auth.onAuthStateChanged(async (user) => {
            setUser(user);

            if (!user) {
              window.location.href = "/login.html";
              return;
            }

            if (!user.emailVerified) {
              window.location.href = "/login.html";
              return;
            }

            // Load everything after auth is confirmed
            await Promise.all([
              loadSavedTemplatesList(user.uid), // ADD THIS LINE
              loadPurchasedTemplates(user.uid),
              loadUserProfile(user),
            ]);

            setLoading(false);
          });

          return () => unsubscribe();
        }, []);

        const loadPurchasedTemplates = async (userId) => {
          try {
            setLoading(true);

            const templatesSnapshot = await db
              .collection("users")
              .doc(userId)
              .collection("purchasedInvoiceTemplates")
              .get();

            const templates = [];
            const now = new Date();

            templatesSnapshot.forEach((doc) => {
              const template = doc.data();

              // Check if template has expiry date
              if (template.expiryDate) {
                const expiryDate = template.expiryDate.toDate();

                // Only add non-expired templates
                if (now <= expiryDate) {
                  templates.push({
                    id: doc.id,
                    ...template,
                    expired: false,
                  });
                }
              } else {
                // If no expiry date, include the template
                templates.push({
                  id: doc.id,
                  ...template,
                  expired: false,
                });
              }
            });

            setPurchasedTemplates(templates);

            // Check if a template was selected from URL
            const urlParams = new URLSearchParams(window.location.search);
            const templateFromUrl = urlParams.get("template");

            if (
              templateFromUrl &&
              isTemplateAvailableCheck(templateFromUrl, templates)
            ) {
              selectedTemplate = templateFromUrl;
            } else if (templates.length > 0) {
              // Use first template as default
              selectedTemplate = templates[0].id;
            }

            // Re-render with the selected template
            renderInvoicePreview();

            setLoading(false);
          } catch (error) {
            console.error("Error loading templates:", error);
            setLoading(false);
          }
        };
        const loadAndApplyTemplate = async (templateId) => {
          if (!templateId || templateId === "null") {
            // Reset to default
            setCurrentTemplateStyles(null);
            setBranding({
              logo: null,
              primaryColor: "#3B82F6",
              companyName: "Your Business Ltd",
              tagline: "Professional Services",
              font: "Inter, system-ui, sans-serif",
            });
            return;
          }

          try {
            setLoading(true);

            // Fetch the template from Firebase
            const templateDoc = await db
              .collection("users")
              .doc(user.uid)
              .collection("invoiceTemplates")
              .doc(templateId)
              .get();

            if (!templateDoc.exists) {
              alert("Template not found");
              setLoading(false);
              return;
            }

            const template = templateDoc.data();

            // Apply template styles and branding
            if (template.branding) {
              setBranding({
                primaryColor: template.branding.primaryColor || "#3B82F6",
                logo: template.branding.logo || null,
                tagline: template.branding.tagline || "Professional Services",
                companyName:
                  template.branding.companyName || "Your Business Ltd",
                font: template.branding.font || "Inter, system-ui, sans-serif",
              });
            }

            // Store template styles
            if (template.styles) {
              setCurrentTemplateStyles(template.styles);
            }

            setLoading(false);
          } catch (error) {
            console.error("Error loading template:", error);
            alert("Error loading template: " + error.message);
            setLoading(false);
          }
        };

        const loadSavedTemplatesList = async (userId) => {
          try {
            const templatesSnapshot = await db
              .collection("users")
              .doc(userId)
              .collection("invoiceTemplates")
              .get();

            const templates = [];
            templatesSnapshot.forEach((doc) => {
              templates.push({
                id: doc.id,
                ...doc.data(),
              });
            });

            setSavedTemplates(templates);
          } catch (error) {
            console.error("Error loading templates list:", error);
          }
        };

        // Helper function to check template availability
        const isTemplateAvailableCheck = (templateId, templates) => {
          return templates.some((t) => t.id === templateId);
        };
        const calculateTotals = () => {
          const subtotal = invoiceData.items.reduce(
            (sum, item) => sum + item.amount,
            0
          );
          const tax = subtotal * 0.1;
          const total = subtotal + tax;
          return { subtotal, tax, total };
        };

        const { subtotal, tax, total } = calculateTotals();

        const addLineItem = () => {
          setInvoiceData({
            ...invoiceData,
            items: [
              ...invoiceData.items,
              { description: "New Item", quantity: 1, rate: 0, amount: 0 },
            ],
          });
        };

        const updateLineItem = (index, field, value) => {
          const newItems = [...invoiceData.items];
          newItems[index][field] = value;
          if (field === "quantity" || field === "rate") {
            newItems[index].amount =
              newItems[index].quantity * newItems[index].rate;
          }
          setInvoiceData({ ...invoiceData, items: newItems });
        };

        const removeLineItem = (index) => {
          setInvoiceData({
            ...invoiceData,
            items: invoiceData.items.filter((_, i) => i !== index),
          });
        };

        const handleLogoUpload = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () =>
              setBranding({ ...branding, logo: reader.result });
            reader.readAsDataURL(file);
          }
        };

        const handleDragStart = (e, index) => {
          setDraggedSection(index);
          e.currentTarget.classList.add("dragging");
        };

        const handleDragEnd = (e) => {
          e.currentTarget.classList.remove("dragging");
          setDraggedSection(null);
        };

        const handleDrop = (e, dropIndex) => {
          e.preventDefault();
          if (draggedSection === null || draggedSection === dropIndex) return;
          const newSections = [...sections];
          const [removed] = newSections.splice(draggedSection, 1);
          newSections.splice(dropIndex, 0, removed);
          setSections(newSections);
        };

        const handleTemplateSelect = (templateId) => {
          if (isTemplateAvailable(templateId)) {
            setSelectedTemplate(templateId);
          } else {
            alert(
              "This template requires a license. Please purchase it from the Templates page."
            );
          }
        };

        const saveInvoiceForPreview = () => {
          const dataToSave = {
            branding,
            invoiceData,
            selectedTemplate,
            sections,
          };
          sessionStorage.setItem("invoiceData", JSON.stringify(dataToSave));
          window.open("invoice-viewer.html", "_blank");
        };

        const renderSection = (section) => {
          if (!section.visible) return null;

          // Template-specific styling
          const getTemplateStyles = () => {
            if (currentTemplateStyles) {
              return currentTemplateStyles;
            }

            switch (selectedTemplate) {
              case "classic":
                return {
                  headerBg: "bg-gray-100",
                  headerBorder: "border-b-4 border-double",
                  titleSize: "text-3xl sm:text-5xl",
                  sectionTitle: "uppercase tracking-wider font-serif",
                  tableBorder: "border-2",
                  cardBg: "bg-gray-100",
                };
              case "creative":
                return {
                  headerBg: "bg-gradient-to-r from-purple-50 to-pink-50",
                  headerBorder: "border-b-4",
                  titleSize: "text-3xl sm:text-5xl font-black italic",
                  sectionTitle: "uppercase font-bold",
                  tableBorder: "border-l-4",
                  cardBg: "bg-gradient-to-br from-blue-50 to-purple-50",
                };
              case "corporate":
                return {
                  headerBg: "bg-slate-50",
                  headerBorder: "border-b-2",
                  titleSize: "text-2xl sm:text-4xl uppercase tracking-wide",
                  sectionTitle: "uppercase text-xs tracking-widest",
                  tableBorder: "border",
                  cardBg: "bg-slate-50",
                };
              case "minimal":
                return {
                  headerBg: "",
                  headerBorder: "border-b",
                  titleSize: "text-xl sm:text-3xl font-light",
                  sectionTitle: "font-light text-sm",
                  tableBorder: "border-0",
                  cardBg: "bg-white border",
                };
              case "elegant":
                return {
                  headerBg: "bg-amber-50",
                  headerBorder: "border-b-2",
                  titleSize: "text-3xl sm:text-4xl font-serif",
                  sectionTitle: "font-serif italic",
                  tableBorder: "border-b-2",
                  cardBg: "bg-amber-50",
                };
              default: // modern
                return {
                  headerBg: "",
                  headerBorder: "border-b-2",
                  titleSize: "text-2xl sm:text-4xl",
                  sectionTitle: "font-semibold",
                  tableBorder: "border-b-2",
                  cardBg: "bg-gray-50",
                };
            }
          };

          const styles = getTemplateStyles();

          switch (section.id) {
            case "header":
              return (
                <div
                  key={section.id}
                  className={`flex flex-col sm:flex-row justify-between items-start mb-8 pb-6 ${
                    styles.headerBorder
                  } ${styles.headerBg} gap-4 ${
                    styles.headerBg ? "p-4 rounded-lg" : ""
                  }`}
                  style={{ borderColor: branding.primaryColor }}
                >
                  <div className="flex items-center gap-4">
                    {branding.logo && (
                      <img
                        src={branding.logo}
                        alt="Logo"
                        className="h-12 sm:h-16 w-12 sm:w-16 object-contain"
                      />
                    )}
                    <div>
                      <h1
                        className={`${styles.titleSize} font-bold mb-1`}
                        style={{ color: branding.primaryColor }}
                      >
                        INVOICE
                      </h1>
                      <p className="text-gray-600 text-xs sm:text-sm">
                        {branding.tagline}
                      </p>
                    </div>
                  </div>
                  <div className="text-left sm:text-right text-xs sm:text-sm">
                    <p className="font-semibold">#{invoiceData.number}</p>
                    <p className="text-gray-600">Date: {invoiceData.date}</p>
                    <p className="text-gray-600">Due: {invoiceData.dueDate}</p>
                    <p className="text-gray-600">
                      Type: {invoiceData.serviceType}
                    </p>
                    <p className="text-gray-600">
                      Code: {invoiceData.merchantCode}
                    </p>
                  </div>
                </div>
              );

            case "client":
              return (
                <div
                  key={section.id}
                  className="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8 text-sm"
                >
                  <div>
                    <h3
                      className={`${styles.sectionTitle} mb-2`}
                      style={{ color: branding.primaryColor }}
                    >
                      Invoice To
                    </h3>
                    <p className="font-semibold">{invoiceData.from.name}</p>
                    <p className="text-gray-600">{invoiceData.from.address}</p>
                    <p className="text-gray-600">{invoiceData.from.city}</p>
                    <p className="text-gray-600">{invoiceData.from.email}</p>
                    <p className="text-gray-600">{invoiceData.from.phone}</p>
                  </div>
                  <div>
                    <h3
                      className={`${styles.sectionTitle} mb-2`}
                      style={{ color: branding.primaryColor }}
                    >
                      Bill To
                    </h3>
                    <p className="font-semibold">{invoiceData.to.name}</p>
                    <p className="text-gray-600">{invoiceData.to.address}</p>
                    <p className="text-gray-600">{invoiceData.to.city}</p>
                    <p className="text-gray-600">{invoiceData.to.email}</p>
                    <p className="text-gray-600">{invoiceData.to.phone}</p>
                  </div>
                </div>
              );

            case "vehicle":
              return (
                <div
                  key={section.id}
                  className={`mb-8 p-4 ${styles.cardBg} rounded-lg`}
                >
                  <h3
                    className={`${styles.sectionTitle} mb-3`}
                    style={{ color: branding.primaryColor }}
                  >
                    VEHICLE DETAILS
                  </h3>
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                    <div>
                      <span className="text-gray-600">Registration:</span>{" "}
                      <span className="font-medium">
                        {invoiceData.vehicle.registration}
                      </span>
                    </div>
                    <div>
                      <span className="text-gray-600">Make:</span>{" "}
                      <span className="font-medium">
                        {invoiceData.vehicle.make}
                      </span>
                    </div>
                    <div>
                      <span className="text-gray-600">Model:</span>{" "}
                      <span className="font-medium">
                        {invoiceData.vehicle.model}
                      </span>
                    </div>
                    <div>
                      <span className="text-gray-600">Engine:</span>{" "}
                      <span className="font-medium">
                        {invoiceData.vehicle.engine}
                      </span>
                    </div>
                    <div>
                      <span className="text-gray-600">VIN:</span>{" "}
                      <span className="font-medium">
                        {invoiceData.vehicle.vin}
                      </span>
                    </div>
                    <div>
                      <span className="text-gray-600">Odometer:</span>{" "}
                      <span className="font-medium">
                        {invoiceData.vehicle.odometer}
                      </span>
                    </div>
                  </div>
                </div>
              );

            case "items":
              return (
                <div key={section.id} className="mb-8 overflow-x-auto">
                  <table className="w-full min-w-[500px]">
                    <thead>
                      <tr
                        className={styles.tableBorder}
                        style={{ borderColor: branding.primaryColor }}
                      >
                        <th className="text-left py-3 text-sm font-semibold">
                          Description
                        </th>
                        <th className="text-right py-3 text-sm font-semibold">
                          Qty
                        </th>
                        <th className="text-right py-3 text-sm font-semibold">
                          Rate
                        </th>
                        <th className="text-right py-3 text-sm font-semibold">
                          Amount
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {invoiceData.items.map((item, i) => (
                        <tr key={i} className="border-b border-gray-200">
                          <td className="py-3 text-sm">{item.description}</td>
                          <td className="text-right py-3 text-sm">
                            {item.quantity}
                          </td>
                          <td className="text-right py-3 text-sm">
                            ${item.rate.toFixed(2)}
                          </td>
                          <td className="text-right py-3 text-sm font-semibold">
                            ${item.amount.toFixed(2)}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              );

            case "totals":
              return (
                <div key={section.id} className="flex justify-end mb-8">
                  <div className="w-full sm:w-72">
                    <div className="flex justify-between py-2 text-sm">
                      <span className="text-gray-600">Subtotal:</span>
                      <span className="font-medium">
                        ${subtotal.toFixed(2)}
                      </span>
                    </div>
                    <div className="flex justify-between py-2 text-sm">
                      <span className="text-gray-600">Tax (10%):</span>
                      <span className="font-medium">${tax.toFixed(2)}</span>
                    </div>
                    <div
                      className="flex justify-between py-3 border-t-2 mt-2 font-bold text-lg sm:text-xl"
                      style={{
                        borderColor: branding.primaryColor,
                        color: branding.primaryColor,
                      }}
                    >
                      <span>Total:</span>
                      <span>${total.toFixed(2)}</span>
                    </div>
                  </div>
                </div>
              );

            case "notes":
              return (
                <div
                  key={section.id}
                  className="text-sm text-gray-600 border-t pt-6"
                >
                  <p className="font-semibold mb-2">Notes:</p>
                  <p>{invoiceData.notes}</p>
                </div>
              );

            default:
              return null;
          }
        };

        const renderTemplatePreview = () => {
          return (
            <div
              className="bg-white p-4 sm:p-8 rounded-lg invoice-preview shadow-lg"
              style={{ fontFamily: branding.font }}
            >
              {sections.map((section) => renderSection(section))}
            </div>
          );
        };

        if (loading) {
          return (
            <div className="min-h-screen flex items-center justify-center">
              <div className="text-center">
                <div className="text-4xl mb-4">‚è≥</div>
                <p className="text-gray-600">Loading templates...</p>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen">
            {/* Mobile Overlay */}
            <div
              className={`mobile-overlay ${sidebarOpen ? "open" : ""}`}
              onClick={() => setSidebarOpen(false)}
            ></div>

            {/* Header */}
            <div className="no-print bg-white border-b shadow-sm sticky top-0 z-50">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 py-4">
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-3">
                    <button
                      onClick={() => setSidebarOpen(!sidebarOpen)}
                      className="hamburger-menu lg:hidden p-2 hover:bg-gray-100 rounded"
                    >
                      <svg
                        className="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M4 6h16M4 12h16M4 18h16"
                        />
                      </svg>
                    </button>
                    <div>
                      <h1 className="text-xl sm:text-2xl font-bold">
                        Invoice Manager
                      </h1>
                      <p className="text-gray-600 text-xs sm:text-sm hidden sm:block">
                        Create professional invoices
                      </p>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={saveInvoiceForPreview}
                      className="px-3 sm:px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
                    >
                      üëÅÔ∏è <span className="hidden sm:inline">View</span>
                    </button>
                    <button
                      onClick={() => window.print()}
                      className="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
                    >
                      üñ®Ô∏è <span className="hidden sm:inline">Print</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div
              className="no-print border-b overflow-x-auto"
              style={{ background: "#c0c2c4" }}
            >
              <div className="max-w-7xl mx-auto px-4 sm:px-6">
                <div className="flex gap-1 min-w-max">
                  {["editor", "branding", "preview"].map((tab) => (
                    <button
                      key={tab}
                      onClick={() => setActiveTab(tab)}
                      className={`px-4 sm:px-6 py-3 font-medium text-sm whitespace-nowrap ${
                        activeTab === tab
                          ? "border-b-2 border-blue-600 text-blue-600"
                          : "text-gray-600"
                      }`}
                    >
                      {tab === "editor"
                        ? "‚úèÔ∏è Edit"
                        : tab === "branding"
                        ? "‚öôÔ∏è Branding"
                        : "üëÅÔ∏è Preview"}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            {/* Main Content */}
            <div className="max-w-full mx-1 px-1 sm:px-6 py-1 sm:py-8">
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-8">
                {/* Sidebar */}
                <div
                  className={`mobile-sidebar ${
                    sidebarOpen ? "open" : ""
                  } lg:col-span-1`}
                >
                  <div className="bg-gray-300 rounded-lg shadow-sm border p-4 sm:p-6 lg:sticky lg:top-4 max-h-[calc(100vh-120px)] overflow-y-auto">
                    {/* Close button for mobile */}
                    <button
                      onClick={() => setSidebarOpen(false)}
                      className="lg:hidden absolute top-4 right-4 text-gray-500 hover:text-gray-700"
                    >
                      <svg
                        className="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M6 18L18 6M6 6l12 12"
                        />
                      </svg>
                    </button>
                    {activeTab === "editor" && (
                      <div className="space-y-6">
                        <div>
                          <h3 className="text-lg font-semibold mb-4">
                            Invoice Details
                          </h3>

                          <label className="block text-sm font-medium mb-2">
                            Invoice Number
                          </label>
                          <input
                            type="text"
                            value={invoiceData.number}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                number: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-3 text-sm"
                          />

                          <label className="block text-sm font-medium mb-2">
                            Date
                          </label>
                          <input
                            type="date"
                            value={invoiceData.date}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                date: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-3 text-sm"
                          />

                          <label className="block text-sm font-medium mb-2">
                            Due Date
                          </label>
                          <input
                            type="date"
                            value={invoiceData.dueDate}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                dueDate: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-3 text-sm"
                          />

                          <label className="block text-sm font-medium mb-2">
                            Service Type
                          </label>
                          <input
                            type="text"
                            value={invoiceData.serviceType}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                serviceType: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-3 text-sm"
                          />

                          <label className="block text-sm font-medium mb-2">
                            Merchant Code
                          </label>
                          <input
                            type="text"
                            value={invoiceData.merchantCode}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                merchantCode: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-3 text-sm"
                          />
                        </div>

                        <div>
                          <h4 className="font-semibold mb-3">
                            Invoice To(Your Business)
                          </h4>
                          <input
                            type="text"
                            value={invoiceData.from.name}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                from: {
                                  ...invoiceData.from,
                                  name: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Business Name"
                          />
                          <input
                            type="text"
                            value={invoiceData.from.address}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                from: {
                                  ...invoiceData.from,
                                  address: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Address"
                          />
                          <input
                            type="text"
                            value={invoiceData.from.city}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                from: {
                                  ...invoiceData.from,
                                  city: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="City, State ZIP"
                          />
                          <input
                            type="email"
                            value={invoiceData.from.email}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                from: {
                                  ...invoiceData.from,
                                  email: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Email"
                          />
                          <input
                            type="tel"
                            value={invoiceData.from.phone}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                from: {
                                  ...invoiceData.from,
                                  phone: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg text-sm"
                            placeholder="Phone"
                          />
                        </div>

                        <div>
                          <h4 className="font-semibold mb-3">
                            Bill To (Client)
                          </h4>
                          <input
                            type="text"
                            value={invoiceData.to.name}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                to: { ...invoiceData.to, name: e.target.value },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Client Name"
                          />
                          <input
                            type="text"
                            value={invoiceData.to.address}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                to: {
                                  ...invoiceData.to,
                                  address: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Address"
                          />
                          <input
                            type="text"
                            value={invoiceData.to.city}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                to: { ...invoiceData.to, city: e.target.value },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="City, State ZIP"
                          />
                          <input
                            type="email"
                            value={invoiceData.to.email}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                to: {
                                  ...invoiceData.to,
                                  email: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Email"
                          />
                          <input
                            type="tel"
                            value={invoiceData.to.phone}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                to: {
                                  ...invoiceData.to,
                                  phone: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg text-sm"
                            placeholder="Phone"
                          />
                        </div>

                        <div>
                          <h4 className="font-semibold mb-3">
                            Vehicle Details
                          </h4>
                          <input
                            type="text"
                            value={invoiceData.vehicle.registration}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                vehicle: {
                                  ...invoiceData.vehicle,
                                  registration: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Registration"
                          />
                          <input
                            type="text"
                            value={invoiceData.vehicle.make}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                vehicle: {
                                  ...invoiceData.vehicle,
                                  make: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Make"
                          />
                          <input
                            type="text"
                            value={invoiceData.vehicle.model}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                vehicle: {
                                  ...invoiceData.vehicle,
                                  model: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Model"
                          />
                          <input
                            type="text"
                            value={invoiceData.vehicle.odometer}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                vehicle: {
                                  ...invoiceData.vehicle,
                                  odometer: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg text-sm"
                            placeholder="Odometer"
                          />
                        </div>

                        <div>
                          <h4 className="font-semibold mb-3">Line Items</h4>
                          {invoiceData.items.map((item, i) => (
                            <div
                              key={i}
                              className="p-3 bg-gray-50 rounded border mb-2"
                            >
                              <input
                                type="text"
                                value={item.description}
                                onChange={(e) =>
                                  updateLineItem(
                                    i,
                                    "description",
                                    e.target.value
                                  )
                                }
                                className="w-full px-2 py-1 text-sm border rounded mb-2"
                                placeholder="Description"
                              />
                              <div className="grid grid-cols-4 gap-2">
                                <input
                                  type="number"
                                  value={item.quantity}
                                  onChange={(e) =>
                                    updateLineItem(
                                      i,
                                      "quantity",
                                      parseFloat(e.target.value) || 0
                                    )
                                  }
                                  className="px-2 py-1 text-sm border rounded"
                                  placeholder="Qty"
                                />
                                <input
                                  type="number"
                                  value={item.rate}
                                  onChange={(e) =>
                                    updateLineItem(
                                      i,
                                      "rate",
                                      parseFloat(e.target.value) || 0
                                    )
                                  }
                                  className="px-2 py-1 text-sm border rounded"
                                  placeholder="Rate"
                                />
                                <span className="text-xs font-medium flex items-center justify-center bg-white border rounded">
                                  ${item.amount.toFixed(2)}
                                </span>
                                <button
                                  onClick={() => removeLineItem(i)}
                                  className="text-red-600 text-xs hover:text-red-800 bg-red-50 rounded"
                                >
                                  Remove
                                </button>
                              </div>
                            </div>
                          ))}
                          <button
                            onClick={addLineItem}
                            className="w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 text-sm"
                          >
                            + Add Item
                          </button>
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-2">
                            Notes
                          </label>
                          <textarea
                            value={invoiceData.notes}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                notes: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg text-sm"
                            rows="3"
                          />
                        </div>
                      </div>
                    )}

                    {activeTab === "branding" && (
                      <div className="space-y-6">
                        <div>
                          <h3 className="text-lg font-semibold mb-4">
                            Brand Settings
                          </h3>
                          <label className="block text-sm font-medium mb-2">
                            Select Saved Template
                          </label>
                          <select
                            value={selectedTemplate}
                            onChange={(e) => {
                              setSelectedTemplate(e.target.value);
                              loadAndApplyTemplate(e.target.value);
                            }}
                            className="w-full px-3 py-2 border rounded-lg mb-4"
                          >
                            <option value="null">Default Template</option>
                            {savedTemplates.map((template) => (
                              <option key={template.id} value={template.id}>
                                {template.name}
                              </option>
                            ))}
                          </select>
                          <p className="text-xs text-gray-500 mb-4">
                            Choose a saved template to apply custom styling
                          </p>

                          <label className="block text-sm font-medium mb-2">
                            Company Logo
                          </label>
                          <div className="flex items-center gap-4 mb-4">
                            {branding.logo ? (
                              <img
                                src={branding.logo}
                                alt="Logo"
                                className="h-20 w-20 object-contain border rounded p-2"
                              />
                            ) : (
                              <div className="h-20 w-20 border-2 border-dashed rounded flex items-center justify-center text-gray-400">
                                No Logo
                              </div>
                            )}
                            <label className="cursor-pointer px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                              Upload Logo
                              <input
                                type="file"
                                className="hidden"
                                accept="image/*"
                                onChange={handleLogoUpload}
                              />
                            </label>
                          </div>

                          <label className="block text-sm font-medium mb-2">
                            Company Name
                          </label>
                          <input
                            type="text"
                            value={branding.companyName}
                            onChange={(e) =>
                              setBranding({
                                ...branding,
                                companyName: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-4"
                          />

                          <label className="block text-sm font-medium mb-2">
                            Tagline
                          </label>
                          <input
                            type="text"
                            value={branding.tagline}
                            onChange={(e) =>
                              setBranding({
                                ...branding,
                                tagline: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-4"
                          />

                          <label className="block text-sm font-medium mb-2">
                            Primary Color
                          </label>
                          <div className="flex items-center gap-3 mb-4">
                            <input
                              type="color"
                              value={branding.primaryColor}
                              onChange={(e) =>
                                setBranding({
                                  ...branding,
                                  primaryColor: e.target.value,
                                })
                              }
                              className="h-10 w-20 border rounded cursor-pointer"
                            />
                            <input
                              type="text"
                              value={branding.primaryColor}
                              onChange={(e) =>
                                setBranding({
                                  ...branding,
                                  primaryColor: e.target.value,
                                })
                              }
                              className="flex-1 px-3 py-2 border rounded-lg font-mono text-sm"
                            />
                          </div>

                          <label className="block text-sm font-medium mb-2">
                            Font Style
                          </label>
                          <select
                            value={branding.font}
                            onChange={(e) =>
                              setBranding({ ...branding, font: e.target.value })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-4"
                          >
                            <option value="Inter, system-ui, sans-serif">
                              Sans Serif (Modern)
                            </option>
                            <option value="Georgia, serif">
                              Serif (Classic)
                            </option>
                          </select>
                        </div>

                        <div>
                          <h4 className="font-semibold mb-3">Section Order</h4>
                          <p className="text-sm text-gray-600 mb-3">
                            Drag to reorder sections
                          </p>
                          {sections.map((section, index) => (
                            <div
                              key={section.id}
                              draggable
                              onDragStart={(e) => handleDragStart(e, index)}
                              onDragEnd={handleDragEnd}
                              onDragOver={(e) => e.preventDefault()}
                              onDrop={(e) => handleDrop(e, index)}
                              className="flex items-center justify-between p-3 bg-white border rounded-lg cursor-move hover:border-blue-400 mb-2"
                            >
                              <span className="font-medium text-sm">
                                ‚ò∞ {section.name}
                              </span>
                              <label className="flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  checked={section.visible}
                                  onChange={(e) => {
                                    const newSections = [...sections];
                                    newSections[index].visible =
                                      e.target.checked;
                                    setSections(newSections);
                                  }}
                                  className="w-4 h-4"
                                />
                                <span className="text-sm text-gray-600">
                                  Show
                                </span>
                              </label>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {activeTab === "preview" && (
                      <div className="text-center">
                        <h3 className="text-lg font-semibold mb-4">
                          Preview Mode
                        </h3>
                        <p className="text-sm text-gray-600 mb-4">
                          Your invoice is displayed on the right. Click Print to
                          save as PDF.
                        </p>
                        <button
                          onClick={() => window.print()}
                          className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        >
                          üñ®Ô∏è Print / Save PDF
                        </button>
                      </div>
                    )}
                  </div>
                </div>

                {/* Preview */}
                <div className="lg:col-span-2">
                  <div
                    ref={containerRef}
                    className="relative flex flex-col lg:flex-row gap-0"
                  >
                    {/* Invoice Preview */}
                    <div
                      className="overflow-y-auto"
                      style={{
                        width:
                          window.innerWidth >= 1024 ? `${leftWidth}%` : "100%",
                      }}
                    >
                      <div
                        className="bg-white p-8 rounded-lg shadow-lg invoice-preview"
                        style={{ fontFamily: branding.font }}
                      >
                        {sections.map((section) => renderSection(section))}
                      </div>
                    </div>

                    {/* Resizer - only visible on large screens */}

                    <div
                      className={`hidden lg:block w-1 bg-gray-300 print:hidden hover:bg-gray-500 cursor-col-resize transition-colors ${
                        isResizing ? "bg-gray-500" : ""
                      }`}
                      onMouseDown={handleMouseDown}
                    >
                     
                    </div>
                    {/* Saved Templates */}
                    <div
                      className="overflow-y-auto print:hidden mt-6 lg:mt-0"
                      style={{
                        width:
                          window.innerWidth >= 1024
                            ? `${100 - leftWidth}%`
                            : "100%",
                      }}
                    >
                      <div className="bg-white rounded-lg shadow-sm border p-6">
                        <h3 className="text-lg font-semibold mb-4">
                          Saved Templates
                        </h3>

                        {savedTemplates.length === 0 ? (
                          <p className="text-sm text-gray-500">
                            No saved templates yet
                          </p>
                        ) : (
                          <div className="space-y-2">
                            {savedTemplates.map((template) => (
                              <div
                                key={template.id}
                                className="p-3 bg-gray-50 rounded border"
                              >
                                <div className="flex justify-between items-start mb-2">
                                  <div>
                                    <span className="font-medium text-sm block">
                                      {template.name}
                                    </span>
                                    <span className="text-xs text-gray-500">
                                      {templates.find(
                                        (t) => t.id === template.templateType
                                      )?.name || template.templateType}
                                    </span>
                                  </div>
                                  <button
                                    onClick={() => deleteTemplate(template.id)}
                                    className="text-red-600 text-xs hover:text-red-800"
                                  >
                                    ‚úï
                                  </button>
                                </div>
                                <div className="flex gap-2">
                                  <button
                                    onClick={() => loadTemplate(template.id)}
                                    className="flex-1 px-3 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200"
                                  >
                                    Load to Editor
                                  </button>
                                  <button
                                    onClick={() =>
                                      loadAndViewTemplate(template.id)
                                    }
                                    className="flex-1 px-3 py-1 bg-green-100 text-green-700 rounded text-xs hover:bg-green-200"
                                  >
                                    View Invoice
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(
        <InvoiceManager />
      );
    </script>
    <script></script>
  </body>
</html>
