<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>V8 Powered Auto - Invoice</title>
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/assets/favicon-16x16.png"
    />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: #0f1724;
      }

      .logo {
        width: 60px;
        height: 60px;
        background: transparent;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 12px;
        text-align: center;
      }

      .main-container {
        display: flex;
        height: 100vh; /* full viewport height */
        overflow: hidden; /* no body scroll */
        align-items: stretch; /* make children fill height */
      }
      .sidebar {
        width: 260px;
        background: rgba(15, 23, 36);
        border-right: 1px solid rgba(255, 255, 255, 0.03);
        padding: 28px 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        transform: translateX(0);
        transition: var(--transition);
        z-index: 40;
        backdrop-filter: blur(6px) saturate(120%);
      }
      .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: white; /* match sidebar text color */
        display: none; /* hidden by default */
      }
      .sidebar.open .close-btn {
        display: block; /* show when sidebar opens */
      }

      @media (max-width: 820px) {
        .sidebar {
          position: fixed;
          left: 0;
          top: 0;
          height: 100vh;
          transform: translateX(-320px);
        }
        .sidebar.open {
          transform: translateX(0);
        }
      }
      .invoice-container {
        background-color: #cfe9f7;
        flex: 1; /* fills remaining width next to sidebar */
        overflow-y: auto; /* vertical scroll if content overflows */
        padding: 10px; /* optional internal padding */
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      /* Mobile menu toggle (hidden by default, shown on small screens) */
      .menu-toggle {
        display: none;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 20px;
        cursor: pointer;
        padding: 6px 8px;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: 0.3s;
      }
      .btn-primary {
        background: #d32f2f;
        color: white;
      }
      .btn-primary:hover {
        background: #b71c1c;
      }
      .btn-secondary {
        background: #333;
        color: white;
      }
      .btn-secondary:hover {
        background: #000;
      }
      .btn-success {
        background: #4caf50;
        color: white;
      }
      .btn-success:hover {
        background: #388e3c;
      }

      /* Header */
      .header .header-info{
        display: flex;
        border-bottom: 3px solid #333;
        padding-bottom: 20px;
        margin-bottom: 30px;
      }
      .company-name {
        font-size: 28px;
        font-weight: bold;
        color: #d32f2f;
        margin-bottom: 5px;
      }
      .header-info {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
        margin-top: 15px;
      }
      .contact-info {
        flex: 1;
        font-size: 12px;
        line-height: 1.6;
        color: #666;
        max-width: 40%;
      }
      .contact-info .office-addresses {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 8px;
        margin-bottom: 8px;
        font-size: 12px;
        color: #666;
      }
      .contact-info .office-addresses .office {
        line-height: 1.4;
      }
      .invoice-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 10px;
        width: 40%;
        min-width: 300px;
      }

      .invoice-type {
        font-size: 32px;
        font-weight: bold;
        text-align: right;
        color: #333;
        margin-bottom: 10px;
      }
      .meta-box {
        background: #f9f9f9;
        padding: 8px 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        justify-content: space-between;
        border-radius: 4px;
      }
      .meta-label {
        font-size: 11px;
        color: #666;
        text-transform: uppercase;
        min-width: 120px;
        font-weight: 600;
      }
      .meta-value {
        font-size: 14px;
        font-weight: bold;
      }
      input[type="text"],
      input[type="date"],
      input[type="number"],
      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      textarea {
        resize: vertical;
        min-height: 80px;
        font-family: Arial, sans-serif;
      }

      /* Client & Vehicle Info */
      .info-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .info-title {
        font-size: 12px;
        font-weight: bold;
        background: #727272;
        color: white;
        padding: 8px;
        margin-bottom: 10px;
      }
      .info-content {
        padding: 2px;
        font-size: 13px;
        line-height: 1.8;
      }
      .info-row {
        display: flex;
        margin-bottom: 1px;
        gap: 2px;
      }
      .info-row strong {
        min-width: 70px;
        color: #666;
        margin-right: 2px;
      }
      .info-row input {
        flex: auto;
      }

      /* Items Table Alignment Styles */

      .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
      }

      .items-table thead {
        background: #333;
        color: white;
      }

      .items-table th {
        padding: 12px;
        font-size: 12px;
        text-transform: uppercase;
      }

      /* First column (Description) - left aligned */
      .items-table th:first-child {
        text-align: left;
      }

      /* All other columns - right aligned */
      .items-table th.text-center,
      .items-table th.text-right {
        text-align: right;
      }

      .items-table td {
        padding: 8px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
      }

      /* First column (Description) - left aligned */
      .items-table td:first-child {
        text-align: left;
      }

      /* All other data cells - right aligned */
      .items-table td.text-center,
      .items-table td.text-right {
        text-align: right;
      }

      /* Inputs inside table cells inherit alignment */
      .items-table input {
        width: 100%;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      /* Description input - left aligned */
      .items-table td:first-child input,
      .items-table .item-desc {
        text-align: left;
      }

      /* Quantity and Price inputs - right aligned */
      .items-table .text-center input,
      .items-table .item-qty,
      .items-table .text-right input,
      .items-table .item-price {
        text-align: right;
      }

      .items-table .net-price {
        display: block;
        text-align: right;
        font-weight: bold;
      }

      /* Print styles for table */

      .btn-remove {
        background: #f44336;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      .btn-remove:hover {
        background: #d32f2f;
      }
      .btn-add {
        background: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 20px;
      }
      .btn-add:hover {
        background: #388e3c;
      }

      .totals {
        margin-left: auto; /* Push to the right */
        margin-right: 0;
        width: 300px; /* Fixed width */
        display: block;
      }

      .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        font-size: 14px;
      }

      .total-row span:first-child {
        text-align: left;
        font-weight: 500;
      }

      .total-row span:last-child {
        text-align: right;
        font-weight: bold;
        min-width: 120px;
      }

      .total-row.subtotal {
        border-top: 2px solid #eee;
      }

      .total-row.grand-total {
        background: #333;
        color: white;
        padding: 15px;
        font-size: 18px;
        font-weight: bold;
        margin-top: 10px;
        border-radius: 4px;
      }

      .total-row.grand-total span {
        color: white;
      }

      /* Print styles for totals */
      @media print {
        .totals {
          width: 180px !important;
          margin-left: auto !important;
          margin-right: 0 !important;
          margin-bottom: 10px !important;
          display: block !important;
        }

        .total-row {
          padding: 3px 6px !important;
          font-size: 10px !important;
        }

        .total-row span:last-child {
          min-width: 80px !important;
        }

        .total-row.subtotal {
          border-top: 1px solid #eee !important;
        }

        .total-row.grand-total {
          padding: 6px 8px !important;
          font-size: 11px !important;
          margin-top: 4px !important;
          background: #333 !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
      }
      .signatures {
          display:none;
        }
      .footer {
        display: none;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 2px solid #eee;
      }
      .bank-details {
        background: #f9f9f9;
        padding: 15px;
      }
      
      .bank-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #d32f2f;
      }
      .bank-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        font-size: 13px;
      }
      .bank-info div {
        margin-bottom: 5px;
      }
      .bank-info strong {
        color: #666;
      }

       .bank-details2 {
        background: #f9f9f9;
        padding: 15px;
      }
      
      .addresses {
        margin-top: 20px;
        font-size: 12px;
        color: #666;
      }
      .addresses div {
        margin-bottom: 5px;
      }

      @media print {
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }

        body,
        html {
          margin: 0;
          padding: 0;
          background: white;
        }
        .main-container {
          display: flex;
          height: auto; /* full viewport height */
          overflow: hidden; /* prevent body scroll */
          min-height: auto;
        }
        
        .top-header {
          display: none !important;
        }
        .calendly-inline-widget {
          display: none !important;
        }
        #sidebar {
          display: none !important;
        }
        .header {
          display: block; /* Visible when printing */
        }
        
        /* Main invoice container */
        .invoice-container {
          height: auto; /* Not 100vh or fixed height */
          min-height: auto;
          width: 100%;
          max-width: 100%;
          margin: 0;
          padding: 15mm 10mm; /* Adjust margins for A4 paper */
          box-shadow: none;
          background: white;
          display: flex;
          flex-direction: column;
        }
        .header-info {
          display: flex !important;
          flex-direction: row !important;
          justify-content: space-between !important;
          align-items: flex-start !important;
          gap: 20px !important;
          width: 100% !important;
        }

        .contact-info {
          flex: 0 0 48% !important; /* Fixed width of 48% */
          max-width: 48% !important;
        }

        .invoice-meta {
          flex: 0 0 48% !important; /* Fixed width of 48% */
          max-width: 48% !important;
          align-self: flex-start !important;
        }

        /* Optional: Adjust logo size for print */
        .contact-info img {
          max-width: 200px !important;
          height: auto !important;
        }

        /* Ensure the logo container doesn't break the layout */
        .contact-info > div:first-child {
          margin-bottom: 10px !important;
        }

        

        .office-addresses {
          display: grid !important;
          grid-template-columns: 1fr 1fr !important;
          gap: 6px !important;
          margin-top: 3px !important;
          margin-bottom: 3px !important;
          font-size: 8px !important;
        }

        .office {
          line-height: 1.2 !important;
        }


        .invoice-type {
          font-size: 40px !important;
          text-align: right !important;
          width: 200px !important;
          height: auto !important;
          margin-bottom: 3px !important;
        }

        .meta-box {
          background: #f9f9f9 !important;
          padding: 3px 6px !important;
          margin-bottom: 2px !important;
          width: 100% !important;
          display: flex !important;
          justify-content: space-between !important;
          align-items: center !important;
          gap: 8px !important;
          border-radius: 2px !important;
        }

       .meta-label {
          font-size: 8px !important;
          min-width: 100px !important;
          text-align: left !important;
          font-weight: 600 !important;
          color: #666 !important;
        }

        .meta-box input {
          border: none !important;
          background: transparent !important;
          padding: 1px !important;
          font-size: 9px !important;
          text-align: right !important;
          font-weight: bold !important;
          flex: 1 !important;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        textarea {
          border: none !important;
          background: transparent !important;
          font-size: 10px;
          padding: 0;
          line-height: 1.3;
        }
        .items-table {
          margin-bottom: 8px !important;
          font-size: 9px !important;
        }

        .items-table th {
          padding: 3px 4px !important;
          font-size: 8px !important;
        }

        .items-table td {
          padding: 2px 3px !important;
          font-size: 9px !important;
        }

        .items-table input {
          font-size: 8px !important;
          padding: 1px !important;
          border: none !important;
          background: transparent !important;
        }

        /* Description - left aligned */
        .items-table th:first-child,
        .items-table td:first-child,
        .items-table td:first-child input {
          text-align: left !important;
        }

        /* All other columns - right aligned */
        .items-table th.text-center,
        .items-table th.text-right,
        .items-table td.text-center,
        .items-table td.text-right,
        .items-table td.text-center input,
        .items-table td.text-right input,
        .items-table .net-price {
          text-align: right !important;
        }
        /* Info section */
        .info-section {
          display: flex;
          gap: 10px;
          margin-bottom: 10px;
          font-size: 9px;
        }

        .info-box {
          flex: 1;
        }

        .info-title {
          font-size: 10px;
          padding: 3px 5px;
        }

        .info-content {
          font-size: 9px;
         
        }

        textarea {
          height: auto !important;
          min-height: 60px;
          resize: none;
        }

        .info-row {
          margin-bottom: 3px;
          font-size: 9px;
        }

        /* Items table */
        .items-table {
          width: 100%;
          font-size: 9px;
          margin-bottom: 10px;
        }

        .items-table th {
          font-size: 9px;
          padding: 5px;
        }

        .items-table td {
          padding: 4px;
          font-size: 9px;
        }

        .items-table input {
          font-size: 9px !important;
        }

        /* Hide buttons in print */
        .btn-add,
        .btn-remove,
        button {
          display: none !important;
        }

        /* Totals section */
        .totals {
          font-size: 10px;
          margin-bottom: 10px;
        }

        .total-row {
          padding: 4px 0;
        }

        .grand-total {
          font-size: 12px;
        }
        .signatures {
          display: block;
        }
        /* Footer */
        .footer {
          display: block;
          font-size: 9px;
          margin-top: 15px;
          page-break-inside: avoid;
        }

        .bank-title {
          font-size: 10px;
          padding: 3px 5px;
        }

        .bank-info {
          font-size: 9px;
          padding: 5px;
        }

        .footer p {
          font-size: 9px !important;
        }

        /* Ensure single page */
        @page {
          size: A4;
          margin: 10mm 8mm;
        }

        .header,
        .info-section,
        .totals,
        .footer {
          page-break-inside: avoid;
        }

        /* If content still doesn't fit, scale it down */
        .invoice-container {
          transform: scale(0.95);
          transform-origin: top left;
        }
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .top-header {
          flex-direction: column;
          gap: 15px;
        }
        header-info {
          flex-direction: column;
        }

        .contact-info {
          max-width: 100%;
        }
        /* show menu toggle on small screens, hide full menu by default */
        .menu-toggle {
          display: block !important;
        }
        .menu-items {
          display: none !important;
        }
        .invoice-container {
          padding: 20px;
        }
        .action-buttons {
          flex-wrap: wrap;
        }
        .header-info {
          flex-direction: column;
        }
        .invoice-type {
          text-align: left;
          margin-top: 10px;
        }
        .invoice-meta,
        .info-section {
          grid-template-columns: 1fr;
        }
        .items-table {
          font-size: 12px;
        }
        .items-table th,
        .items-table td {
          padding: 6px 4px;
        }
        .totals {
          width: 100%;
        }
        .bank-info {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <style>
      .hambtn {
        width: 46px;
        height: 46px;
        border-radius: 10px;
        background: var(--glass);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.02);
      }
      @media (min-width: 1024px) {
        .hambtn {
          display: none;
        }
        .close-btn {
          display: none;
        }
      }
      .nav {
        margin-top: 6px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .nav a {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        color: #cfe9f7;
        text-decoration: none;
        border-radius: 10px;
        transition: var(--transition);
        font-size: 14px;
      }
      .nav a .ico {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.02);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
      }
      .nav a:hover {
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        transform: translateX(4px);
      }
      .nav a.active {
        background: linear-gradient(
          90deg,
          rgba(124, 58, 237, 0.15),
          rgba(6, 182, 212, 0.06)
        );
        color: #fff;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
      }
      .spacer {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="top-left">
        <button
          class="hambtn"
          id="hambtn"
          style="color: #cfe9f7"
          aria-label="Open menu"
        >
          ‚ò∞
        </button>
      </div>
      <aside id="sidebar" class="sidebar" aria-hidden="true">
        <button id="closeSidebar" class="close-btn" aria-label="Close menu">
          ‚úï
        </button>
        <div class="brand" style="padding: 20px;">
          <div class="logo" >
            <img
              src="/assets/img/solidflo-logo.png"
              style="height: 60px"
              alt=""
            />
          </div>
          <div>
            <p style="color: #9aa7b2; font-size: 12px">Quotations & Billing</p>
          </div>
        </div>

        <nav class="nav" aria-label="Main navigation" style="padding: 20px;">
          <a class="active" href="/dashboard/index.html"
            ><span class="ico">üè†</span><span class="label">Dashboard</span></a
          >
          <a href="/dashboard/invoices.html"
            ><span class="ico">üìÑ</span><span class="label">Invoices</span></a
          >
          <a class="active" href="/dashboard/quotations.html">
            <span class="ico">üìÑ</span><span>Quotations</span>
          </a>
          <a href="/dashboard/clients.html"
            ><span class="ico">üë•</span><span class="label">Clients</span></a
          >
          <a href="/dashboard/payments.html"
            ><span class="ico">üí≥</span><span class="label">Payments</span></a
          >
          <button class="btn btn-primary" onclick="createNewInvoice()">
            New Invoice
          </button>
          <button class="btn btn-secondary" onclick="saveInvoiceToFirebase()">
            Save
          </button>
          <button class="btn btn-primary" onclick="savePDF()">
            Save as PDF
          </button>
          <a href="#"
            ><span class="ico">üìä</span><span class="label">Reports</span></a
          >
        </nav>

        <div class="spacer"></div>

        <div class="flex">
        <div
          style="
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.04);
            display: flex;
            align-items: center;
            justify-content: center;
          "
        >
          üë§
        </div>
        <div>
          <div style="font-weight: 700; color: white">User</div>
          <div style="font-size: 12px; color: #9aa7b2">Admin</div>
        </div>
      </div>
      </aside>
      <div class="sidebar-overlay" id="sidebarOverlay"></div>

      <div class="invoice-container" id="invoice" style="flex: block">
        <!-- Header -->
        <div class="header">

          <div class="header-info">
            <!-- LEFT SIDE: Logo and Contact Info -->
            <div class="contact-info">
              <div>
                <img
                  src="/assets/img/v8-logo.png"
                  alt=""
                  style="width: 300px"
                />
              </div>

              <div class="office-addresses">
                <div class="office">
                  <strong>HEAD OFFICE:</strong><br />
                  8-10 CNR THIRD &amp; ARKWRIGHT AVENUE<br />
                  WYNBERG SANDTON 2090,<br />

                  <strong>BRANCH:</strong><br />
                  1 LINBRI AVE GROBLERSDAL<br />
                  LIMPOPO 0470 <br />
                  W: v8poweredrc.co.za<br />
                  E: info@v8poweredrc.co.za<br />
                  T: 062 114 4500, 064 503 0029
                </div>
              </div>
            </div>

            <!-- RIGHT SIDE: Invoice Meta -->
            <div class="invoice-meta">
              <div class="invoice-type">INVOICE</div>

              <div class="meta-box">
                <div class="meta-label">Invoice No.</div>
                <input type="text" id="invoiceNumber" value="INV-2025-001" />
              </div>

              <div class="meta-box">
                <div class="meta-label">Date</div>
                <input type="date" id="invoiceDate" value="2025-12-08" />
              </div>

              <div class="meta-box">
                <div class="meta-label">Merchant Code</div>
                <select id="merchantCode" style="width: 100%; padding: 8px; border: none; background-color: transparent; text-align: right;" onchange="updateBankDetails()">
                  <option value="811371">811371</option>
                  <option value="807411">807411</option>
                </select>
              </div>

              <div class="meta-box">
                <div class="meta-label">Service Type</div>
                <input type="text" id="serviceType" value="SERVICE" />
              </div>
            </div>
          </div>
        </div>
        <!-- Invoice Meta -->

        <!-- Client & Vehicle Info -->
        <div class="info-section">
          <div class="info-box" style="border: 1px solid #b9b7b7;border-radius: 5px; box-shadow: #cfe9f7; ">
            <div class="info-title">INVOICE TO</div>
            <div class="info-content">
              <div class="info-row">
                <strong>Name:</strong>
                <input type="text" id="clientName" value="Customer" />
              </div>
              <div class="info-row">
                <strong>Company:</strong>
                <input type="text" id="emailAddress" value="ABC Limited" />
              </div>
              <div class="info-row">
                <strong>Address:</strong>
                <textarea
                  id="clientInfo"
                  placeholder="Enter client name and address"
                  style="text-align: start"
                >
123 Main Street Sandton, Johannesburg 2090
                </textarea>
              </div>
              <div class="info-row">
                <strong>Email:</strong>
                <input type="text" id="regNumber" value="ABC 123 GP" />
              </div>
              <div class="info-row">
                <strong>Tel:</strong>
                <input type="text" id="regNumber" value="ABC 123 GP" />
              </div>
            </div>
          </div>
          <div class="info-box" style="border: 1px solid #b9b7b7;border-radius: 5px; box-shadow: #cfe9f7;">
            <div class="info-title">BILL TO</div>
            <div class="info-content">
              <div class="info-row">
                <strong>Name:</strong>
                <input type="text" id="clientName" style="color: #00000052;" value="Customer" />
              </div>
              <div class="info-row">
                <strong>Company:</strong>
                <input type="text" id="emailAddress" value="ABC Limited" />
              </div>
              <div class="info-row">
                <strong>Address:</strong>
                <textarea
                  id="clientInfo"
                  placeholder="Enter client name and address"
                  style="text-align: start"
                >
123 Main Street Sandton, Johannesburg 2090
                </textarea>
              </div>
              <div class="info-row">
                <strong>Email:</strong>
                <input type="text" id="regNumber" value="ABC 123 GP" />
              </div>
              <div class="info-row">
                <strong>Tel:</strong>
                <input type="text" id="regNumber" value="ABC 123 GP" />
              </div>
            </div>
          </div>
          <div class="info-box" style="border: 1px solid #b9b7b7;border-radius: 5px; box-shadow: #cfe9f7;">
            <div class="info-title">VEHICLE DETAILS</div>
            <div class="info-content">
              <div class="info-row">
                <strong>Reg Number:</strong>
                <input type="text" id="regNumber" value="ABC 123 GP" />
              </div>
              <div class="info-row">
                <strong>Make:</strong>
                <input type="text" id="make" value="Toyota" />
              </div>
              <div class="info-row">
                <strong>Model:</strong>
                <input type="text" id="model" value="Hilux 2.8 GD-6" />
              </div>
              <div class="info-row">
                <strong>Engine No:</strong>
                <input type="text" id="engine" value="h78627282" />
              </div>
              <div class="info-row">
                <strong>VIN Number:</strong>
                <input type="text" id="vinNumber" value="AHTFS26L5G0000000" />
              </div>
              <div class="info-row">
                <strong>Odometer:</strong>
                <input type="text" id="odometer" value="45,230 km" />
              </div>
              <div class="info-row">
                <strong>Pre Auth:</strong>
                <input type="text" id="preAuth" value="AUTH123" />
              </div>
              <div class="info-row">
                <strong>Auth Code:</strong>
                <input type="text" id="authCode" value="456789" />
              </div>
            </div>
          </div>
        </div>

        <!-- Items Table -->
        <table class="items-table" id="itemsTable">
          <thead>
            <tr>
              <th style="width: 55%">ITEM DESCRIPTION</th>
              <th class="text-center" style="width: 10%">QUANTITY</th>
              <th class="text-right" style="width: 15%">UNIT PRICE</th>
              <th class="text-right" style="width: 20%">NET PRICE</th>
            </tr>
          </thead>
          <tbody id="itemsBody">
            <tr class="item-row">
              <td>
                <input
                  type="text"
                  class="item-desc"
                  value="Engine Oil Change - Full Synthetic 5W-30"
                />
              </td>
              <td class="text-center">
                <input
                  type="number"
                  class="item-qty"
                  value="1"
                  min="0"
                  step="1"
                  onchange="calculateRow(this)"
                />
              </td>
              <td class="text-right">
                <input
                  type="number"
                  class="item-price"
                  value="850.00"
                  min="0"
                  step="0.01"
                  onchange="calculateRow(this)"
                />
              </td>
              <td class="text-right">
                <span class="net-price">R 850.00</span>
              </td>
              <td class="text-center">
                <button class="btn-remove" onclick="removeRow(this)">
                  Remove
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <button class="btn-add" onclick="addRow()">+ Add Item</button>

        <!-- Totals -->
        <div class="totals">
          <div class="total-row subtotal">
            <span>Subtotal:</span>
            <span id="subtotal">R 850.00</span>
          </div>
          <div class="total-row">
            <span>VAT:</span>
            <span id="vat">R 127.50</span>
          </div>
          <div class="total-row grand-total">
            <span>TOTAL:</span>
            <span id="total">R 977.50</span>
          </div>
        </div>
         <div>
          <div class="signatures" style="margin-top: 40px; font-size: 10px;">
            <div>
              WORKSHOP SIGNATURE __________________CLIENT  SIGNATURE  ___________________CONTACT NUMBER:  _________________________<br/>
            </div> 
            
          </div>
         </div>
        <!-- Footer -->
        <div class="footer">
          <div id="bank-811371" class="bank-details">
  <div class="bank-title">BANKING DETAILS</div>
  <div class="bank-info">
    <div><strong>Bank Name:</strong> FNB</div>
    <div><strong>Account Holder:</strong> V8 POWERED AUTO</div>
    <div><strong>Branch Name:</strong> LIFESTYLE CENTURION</div>
    <div><strong>Account Number:</strong> 63149991431</div>
  </div>
</div>

<div id="bank-807411" class="bank-details2" style="display: none;">
  <div class="bank-title">BANKING DETAILS</div>
  <div class="bank-info">
    <div><strong>Bank Name:</strong>FNB</div>
    <div><strong>Account Holder:</strong> V8 POWERED AUTO</div>
    <div><strong>Branch Name:</strong> LIFESTYLE CENTURION</div>
    <div><strong>Account Number:</strong> 63149991431</div>
  </div>
</div>
          

          <div style="text-align: center" padding-top: 30px>
            <p style="font-size: 16px; color: #b71c1c">
              NB: All our parts and workmanship have 12 months or 15000KM
              Guarantee.
            </p>
          </div>
        </div>
      </div>

    </div>
 <script type="text/babel">
      const { useState, useRef, useEffect } = React;

      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyD1Xzk2DL-kuxEMgbomupgAF0IQZWso8PQ",
        authDomain: "solidflow-1f753.firebaseapp.com",
        projectId: "solidflow-1f753",
        storageBucket: "solidflow-1f753.firebasestorage.app",
        messagingSenderId: "68885400864",
        appId: "1:68885400864:web:7788e19a073d9a8e79db45",
        measurementId: "G-RTL0CM1B44",
      };

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const auth = firebase.auth();
      const db = firebase.firestore();
      const FullInvoice = ({ invoiceData }) => {
  return (
    <div className="invoice-container" id="invoice">
      {/* Paste your converted JSX invoice here */}
    </div>
  );
};


      const InvoiceManager = () => {
        const [activeTab, setActiveTab] = useState("editor");
        const [sidebarOpen, setSidebarOpen] = useState(false);
        const [user, setUser] = useState(null);
        const [userProfile, setUserProfile] = useState({
          name: "User",
          role: "Admin",
        });
        const [invoiceTemplate, setInvoiceTemplate] = useState(null);
        const [invoices, setInvoices] = useState([]);
        const [template, setTemplates] = useState([]);
        const [selectedInvoiceId, setSelectedInvoiceId] = useState("");
        const [savedTemplates, setSavedTemplates] = useState([]);
        const [purchasedTemplates, setPurchasedTemplates] = useState([]);
        const [selectedTemplate, setSelectedTemplate] = useState("null");
        const [currentTemplateStyles, setCurrentTemplateStyles] =
          useState(null);
        const [loading, setLoading] = useState(true);
        const [branding, setBranding] = useState({
          logo: null,
          primaryColor: "#3B82F6",
          companyName: "Your Business Ltd",
          tagline: "Professional Services",
          font: "Inter, system-ui, sans-serif",
        });

        const [invoiceData, setInvoiceData] = useState({
          number: "",
          date: "",
          dueDate: "",
          serviceType: "SERVICE",
          merchantCode: "",
          from: {
            name: "",
            address: "",
            city: "",
            email: "",
            phone: "",
          },
          to: {
            name: "",
            address: "",
            city: "",
            email: "",
            phone: "",
          },
          vehicle: {
            registration: "",
            make: "",
            model: "",
            engine: "",
            vin: "",
            odometer: "",
          },
          items: [],
          notes: "",
        });
        useEffect(() => {
          const unsubscribe = auth.onAuthStateChanged(async (user) => {
            setUser(user);

            if (!user) {
              window.location.href = "/login.html";
              return;
            }

            if (!user.emailVerified) {
              window.location.href = "/login.html";
              return;
            }

            // Load data
            await Promise.all([
              loadInvoices(user.uid),
              loadTemplates(user.uid),
            ]);

            setLoading(false);
          });

          return () => unsubscribe();
        }, []);
        const loadInvoices = async (userId) => {
          try {
            const snapshot = await db
              .collection("users")
              .doc(userId)
              .collection("invoices")
              .get();

            const invoicesData = [];
            snapshot.forEach((doc) => {
              invoicesData.push({
                id: doc.id,
                ...doc.data(),
              });
            });

            setInvoices(invoicesData);

            // Set first invoice as default
            if (invoicesData.length > 0) {
              setSelectedInvoiceId(invoicesData[0].id);
            }
          } catch (error) {
            console.error("Error loading invoices:", error);
          }
        };
        const loadTemplates = async (userId) => {
          try {
            const snapshot = await db
              .collection("users")
              .doc(userId)
              .collection("invoiceTemplates")
              .get();

            const templatesData = [];
            snapshot.forEach((doc) => {
              templatesData.push({
                id: doc.id,
                ...doc.data(),
              });
            });

            setTemplates(templatesData);

            // Set first template as default
            if (templatesData.length > 0) {
              setSelectedTemplateId(templatesData[0].id);
              loadAndApplyTemplate(templatesData[0].id, userId);
            }
          } catch (error) {
            console.error("Error loading templates:", error);
          }
        };
        const loadInvoiceData = async (invoiceId) => {
          try {
            setLoading(true);
            const doc = await db
              .collection("users")
              .doc(user.uid)
              .collection("invoicesTemplates")
              .doc(invoiceId)
              .get();

            if (doc.exists) {
              setInvoiceData(doc.data());
            } else {
              console.log("No invoice found");
            }
          } catch (error) {
            console.error("Error loading invoice:", error);
          } finally {
            setLoading(false);
          }
        };
        const [sections, setSections] = useState([
          { id: "header", name: "Header", visible: true },
          { id: "client", name: "Client Info", visible: true },
          { id: "vehicle", name: "Vehicle Details", visible: true },
          { id: "items", name: "Line Items", visible: true },
          { id: "totals", name: "Totals", visible: true },
          { id: "notes", name: "Notes", visible: true },
        ]);

        const [draggedSection, setDraggedSection] = useState(null);
        const [leftWidth, setLeftWidth] = useState(66.67); // Start at 2/3 width (66.67%)
        const [isResizing, setIsResizing] = useState(false);
        const containerRef = useRef(null);

        const handleMouseDown = (e) => {
          e.preventDefault();
          setIsResizing(true);
        };
        const signInWithEmail = async (email, password) => {
          try {
            await auth.signInWithEmailAndPassword(email, password);
            setShowAuthModal(false);
          } catch (error) {
            alert("Login failed: " + error.message);
          }
        };

        const signUpWithEmail = async (email, password) => {
          try {
            await auth.createUserWithEmailAndPassword(email, password);
            setShowAuthModal(false);
          } catch (error) {
            alert("Sign up failed: " + error.message);
          }
        };

        const signOut = async () => {
          try {
            await auth.signOut();
            setSavedTemplates([]);
          } catch (error) {
            alert("Sign out failed: " + error.message);
          }
        };
        useEffect(() => {
          const handleMouseMove = (e) => {
            if (!isResizing || !containerRef.current) return;

            const container = containerRef.current;
            const containerRect = container.getBoundingClientRect();
            const newLeftWidth =
              ((e.clientX - containerRect.left) / containerRect.width) * 100;

            // Limit between 30% and 80%
            if (newLeftWidth >= 60 && newLeftWidth <= 80) {
              setLeftWidth(newLeftWidth);
            }
          };

          const handleMouseUp = () => {
            setIsResizing(false);
            document.body.style.cursor = '';
          };

          if (isResizing) {
            document.body.style.cursor = 'col-resize'; 
            document.addEventListener("mousemove", handleMouseMove);
            document.addEventListener("mouseup", handleMouseUp);
          }

          return () => {
            document.body.style.cursor = '';
            document.removeEventListener("mousemove", handleMouseMove);
            document.removeEventListener("mouseup", handleMouseUp);
          };
        }, [isResizing]);

        const templates = [
          {
            id: "modern",
            name: "Modern",
            description: "Clean, minimalist design",
            icon: "üìÑ",
            price: 9.99,
          },
          {
            id: "classic",
            name: "Classic",
            description: "Traditional business style",
            icon: "üìã",
            price: 9.99,
          },
          {
            id: "creative",
            name: "Creative",
            description: "Bold and colorful",
            icon: "üé®",
            price: 14.99,
          },
          {
            id: "corporate",
            name: "Corporate",
            description: "Professional enterprise look",
            icon: "üè¢",
            price: 14.99,
          },
        ];
        const allTemplates = [
          {
            id: "modern",
            name: "Modern",
            description: "Clean, minimalist design",
            icon: "üìÑ",
            isPremium: false,
          },
          {
            id: "classic",
            name: "Classic",
            description: "Traditional business style",
            icon: "üìã",
            isPremium: true,
          },
          {
            id: "creative",
            name: "Creative",
            description: "Bold and colorful",
            icon: "üé®",
            isPremium: true,
          },
          {
            id: "corporate",
            name: "Corporate",
            description: "Professional enterprise look",
            icon: "üè¢",
            isPremium: true,
          },
          {
            id: "minimal",
            name: "Minimal",
            description: "Ultra-clean layout",
            icon: "‚ö™",
            isPremium: true,
          },
          {
            id: "elegant",
            name: "Elegant",
            description: "Sophisticated design",
            icon: "‚ú®",
            isPremium: true,
          },
        ];
        const loadUserProfile = async (user) => {
          try {
            const doc = await db.collection("users").doc(user.uid).get();

            if (doc.exists) {
              const userData = doc.data();
              setUserProfile({
                name: userData.name || "User",
                role: userData.role
                  ? userData.role.charAt(0).toUpperCase() +
                    userData.role.slice(1)
                  : "User",
              });
            }
          } catch (error) {
            console.error("Error loading profile:", error);
          }
        };

        // If keeping it in static sidebar outside React
        useEffect(() => {
          if (userProfile.name !== "User") {
            const profileName = document.getElementById("userName");
            if (profileName) {
              profileName.textContent = userProfile.name;
            }
          }
        }, [userProfile]);
        useEffect(() => {
          const unsubscribe = auth.onAuthStateChanged(async (user) => {
            setUser(user);

            if (!user) {
              window.location.href = "/login.html";
              return;
            }

            if (!user.emailVerified) {
              window.location.href = "/login.html";
              return;
            }

            // Load everything after auth is confirmed
            await Promise.all([
              loadSavedTemplatesList(user.uid), // ADD THIS LINE
              loadPurchasedTemplates(user.uid),
              loadUserProfile(user),
            ]);

            setLoading(false);
          });

          return () => unsubscribe();
        }, []);

        const loadPurchasedTemplates = async (userId) => {
          try {
            setLoading(true);

            const templatesSnapshot = await db
              .collection("users")
              .doc(userId)
              .collection("purchasedInvoiceTemplates")
              .get();

            const templates = [];
            const now = new Date();

            templatesSnapshot.forEach((doc) => {
              const template = doc.data();

              // Check if template has expiry date
              if (template.expiryDate) {
                const expiryDate = template.expiryDate.toDate();

                // Only add non-expired templates
                if (now <= expiryDate) {
                  templates.push({
                    id: doc.id,
                    ...template,
                    expired: false,
                  });
                }
              } else {
                // If no expiry date, include the template
                templates.push({
                  id: doc.id,
                  ...template,
                  expired: false,
                });
              }
            });

            setPurchasedTemplates(templates);

            // Check if a template was selected from URL
            const urlParams = new URLSearchParams(window.location.search);
            const templateFromUrl = urlParams.get("template");

            if (
              templateFromUrl &&
              isTemplateAvailableCheck(templateFromUrl, templates)
            ) {
              selectedTemplate = templateFromUrl;
            } else if (templates.length > 0) {
              // Use first template as default
              selectedTemplate = templates[0].id;
            }

            // Re-render with the selected template
            renderInvoicePreview();

            setLoading(false);
          } catch (error) {
            console.error("Error loading templates:", error);
            setLoading(false);
          }
        };
        const loadAndApplyTemplate = async (templateId) => {
          if (!templateId || templateId === "null") {
            // Reset to default
            setCurrentTemplateStyles(null);
            setBranding({
              logo: null,
              primaryColor: "#3B82F6",
              companyName: "Your Business Ltd",
              tagline: "Professional Services",
              font: "Inter, system-ui, sans-serif",
            });
            return;
          }

          try {
            setLoading(true);

            // Fetch the template from Firebase
            const templateDoc = await db
              .collection("users")
              .doc(user.uid)
              .collection("invoiceTemplates")
              .doc(templateId)
              .get();

            if (!templateDoc.exists) {
              alert("Template not found");
              setLoading(false);
              return;
            }

            const template = templateDoc.data();

            // Apply template styles and branding
            if (template.branding) {
              setBranding({
                primaryColor: template.branding.primaryColor || "#3B82F6",
                logo: template.branding.logo || null,
                tagline: template.branding.tagline || "Professional Services",
                companyName:
                  template.branding.companyName || "Your Business Ltd",
                font: template.branding.font || "Inter, system-ui, sans-serif",
              });
            }

            // Store template styles
            if (template.styles) {
              setCurrentTemplateStyles(template.styles);
            }

            setLoading(false);
          } catch (error) {
            console.error("Error loading template:", error);
            alert("Error loading template: " + error.message);
            setLoading(false);
          }
        };

        const loadSavedTemplatesList = async (userId) => {
          try {
            const templatesSnapshot = await db
              .collection("users")
              .doc(userId)
              .collection("invoiceTemplates")
              .get();

            const templates = [];
            templatesSnapshot.forEach((doc) => {
              templates.push({
                id: doc.id,
                ...doc.data(),
              });
            });

            setSavedTemplates(templates);
          } catch (error) {
            console.error("Error loading templates list:", error);
          }
        };

        // Helper function to check template availability
        const isTemplateAvailableCheck = (templateId, templates) => {
          return templates.some((t) => t.id === templateId);
        };
        const calculateTotals = () => {
          const subtotal = invoiceData.items.reduce(
            (sum, item) => sum + item.amount,
            0
          );
          const tax = subtotal * 0.1;
          const total = subtotal + tax;
          return { subtotal, tax, total };
        };

        const { subtotal, tax, total } = calculateTotals();

        const addLineItem = () => {
          setInvoiceData({
            ...invoiceData,
            items: [
              ...invoiceData.items,
              { description: "New Item", quantity: 1, rate: 0, amount: 0 },
            ],
          });
        };

        const updateLineItem = (index, field, value) => {
          const newItems = [...invoiceData.items];
          newItems[index][field] = value;
          if (field === "quantity" || field === "rate") {
            newItems[index].amount =
              newItems[index].quantity * newItems[index].rate;
          }
          setInvoiceData({ ...invoiceData, items: newItems });
        };

        const removeLineItem = (index) => {
          setInvoiceData({
            ...invoiceData,
            items: invoiceData.items.filter((_, i) => i !== index),
          });
        };

        const handleLogoUpload = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () =>
              setBranding({ ...branding, logo: reader.result });
            reader.readAsDataURL(file);
          }
        };

        const handleDragStart = (e, index) => {
          setDraggedSection(index);
          e.currentTarget.classList.add("dragging");
        };

        const handleDragEnd = (e) => {
          e.currentTarget.classList.remove("dragging");
          setDraggedSection(null);
        };

        const handleDrop = (e, dropIndex) => {
          e.preventDefault();
          if (draggedSection === null || draggedSection === dropIndex) return;
          const newSections = [...sections];
          const [removed] = newSections.splice(draggedSection, 1);
          newSections.splice(dropIndex, 0, removed);
          setSections(newSections);
        };

        const handleTemplateSelect = (templateId) => {
          if (isTemplateAvailable(templateId)) {
            setSelectedTemplate(templateId);
          } else {
            alert(
              "This template requires a license. Please purchase it from the Templates page."
            );
          }
        };

        const saveInvoiceForPreview = () => {
          const dataToSave = {
            branding,
            invoiceData,
            selectedTemplate,
            sections,
          };
          sessionStorage.setItem("invoiceData", JSON.stringify(dataToSave));
          window.open("invoice-viewer.html", "_blank");
        };

        const renderSection = (section) => {
          if (!section.visible) return null;

          // Template-specific styling
          const getTemplateStyles = () => {
            if (currentTemplateStyles) {
              return currentTemplateStyles;
            }

            switch (selectedTemplate) {
              case "classic":
                return {
                  headerBg: "bg-gray-100",
                  headerBorder: "border-b-4 border-double",
                  titleSize: "text-3xl sm:text-5xl",
                  sectionTitle: "uppercase tracking-wider font-serif",
                  tableBorder: "border-2",
                  cardBg: "bg-gray-100",
                };
              case "creative":
                return {
                  headerBg: "bg-gradient-to-r from-purple-50 to-pink-50",
                  headerBorder: "border-b-4",
                  titleSize: "text-3xl sm:text-5xl font-black italic",
                  sectionTitle: "uppercase font-bold",
                  tableBorder: "border-l-4",
                  cardBg: "bg-gradient-to-br from-blue-50 to-purple-50",
                };
              case "corporate":
                return {
                  headerBg: "bg-slate-50",
                  headerBorder: "border-b-2",
                  titleSize: "text-2xl sm:text-4xl uppercase tracking-wide",
                  sectionTitle: "uppercase text-xs tracking-widest",
                  tableBorder: "border",
                  cardBg: "bg-slate-50",
                };
              case "minimal":
                return {
                  headerBg: "",
                  headerBorder: "border-b",
                  titleSize: "text-xl sm:text-3xl font-light",
                  sectionTitle: "font-light text-sm",
                  tableBorder: "border-0",
                  cardBg: "bg-white border",
                };
              case "elegant":
                return {
                  headerBg: "bg-amber-50",
                  headerBorder: "border-b-2",
                  titleSize: "text-3xl sm:text-4xl font-serif",
                  sectionTitle: "font-serif italic",
                  tableBorder: "border-b-2",
                  cardBg: "bg-amber-50",
                };
              default: // modern
                return {
                  headerBg: "",
                  headerBorder: "border-b-2",
                  titleSize: "text-2xl sm:text-4xl",
                  sectionTitle: "font-semibold",
                  tableBorder: "border-b-2",
                  cardBg: "bg-gray-50",
                };
            }
          };

          const styles = getTemplateStyles();

          switch (section.id) {
            case "header":
              return (
                <div
                  key={section.id}
                  className={`flex flex-col sm:flex-row justify-between items-start mb-8 pb-6 ${
                    styles.headerBorder
                  } ${styles.headerBg} gap-4 ${
                    styles.headerBg ? "p-4 rounded-lg" : ""
                  }`}
                  style={{ borderColor: branding.primaryColor }}
                >
                  <div className="flex items-center gap-4">
                    {branding.logo && (
                      <img
                        src={branding.logo}
                        alt="Logo"
                        className="h-12 sm:h-16 w-12 sm:w-16 object-contain"
                      />
                    )}
                    <div>
                      <h1
                        className={`${styles.titleSize} font-bold mb-1`}
                        style={{ color: branding.primaryColor }}
                      >
                        INVOICE
                      </h1>
                      <p className="text-gray-600 text-xs sm:text-sm">
                        {branding.tagline}
                      </p>
                    </div>
                  </div>
                  <div className="text-left sm:text-right text-xs sm:text-sm">
                    <p className="font-semibold">#{invoiceData.number}</p>
                    <p className="text-gray-600">Date: {invoiceData.date}</p>
                    <p className="text-gray-600">Due: {invoiceData.dueDate}</p>
                    <p className="text-gray-600">
                      Type: {invoiceData.serviceType}
                    </p>
                    <p className="text-gray-600">
                      Code: {invoiceData.merchantCode}
                    </p>
                  </div>
                </div>
              );

            case "client":
              return (
                <div
                  key={section.id}
                  className="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8 text-sm"
                >
                  <div>
                    <h3
                      className={`${styles.sectionTitle} mb-2`}
                      style={{ color: branding.primaryColor }}
                    >
                      Invoice To
                    </h3>
                    <p className="font-semibold">{invoiceData.from.name}</p>
                    <p className="text-gray-600">{invoiceData.from.address}</p>
                    <p className="text-gray-600">{invoiceData.from.city}</p>
                    <p className="text-gray-600">{invoiceData.from.email}</p>
                    <p className="text-gray-600">{invoiceData.from.phone}</p>
                  </div>
                  <div>
                    <h3
                      className={`${styles.sectionTitle} mb-2`}
                      style={{ color: branding.primaryColor }}
                    >
                      Bill To
                    </h3>
                    <p className="font-semibold">{invoiceData.to.name}</p>
                    <p className="text-gray-600">{invoiceData.to.address}</p>
                    <p className="text-gray-600">{invoiceData.to.city}</p>
                    <p className="text-gray-600">{invoiceData.to.email}</p>
                    <p className="text-gray-600">{invoiceData.to.phone}</p>
                  </div>
                </div>
              );

            case "vehicle":
              return (
                <div
                  key={section.id}
                  className={`mb-8 p-4 ${styles.cardBg} rounded-lg`}
                >
                  <h3
                    className={`${styles.sectionTitle} mb-3`}
                    style={{ color: branding.primaryColor }}
                  >
                    VEHICLE DETAILS
                  </h3>
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                    <div>
                      <span className="text-gray-600">Registration:</span>{" "}
                      <span className="font-medium">
                        {invoiceData.vehicle.registration}
                      </span>
                    </div>
                    <div>
                      <span className="text-gray-600">Make:</span>{" "}
                      <span className="font-medium">
                        {invoiceData.vehicle.make}
                      </span>
                    </div>
                    <div>
                      <span className="text-gray-600">Model:</span>{" "}
                      <span className="font-medium">
                        {invoiceData.vehicle.model}
                      </span>
                    </div>
                    <div>
                      <span className="text-gray-600">Engine:</span>{" "}
                      <span className="font-medium">
                        {invoiceData.vehicle.engine}
                      </span>
                    </div>
                    <div>
                      <span className="text-gray-600">VIN:</span>{" "}
                      <span className="font-medium">
                        {invoiceData.vehicle.vin}
                      </span>
                    </div>
                    <div>
                      <span className="text-gray-600">Odometer:</span>{" "}
                      <span className="font-medium">
                        {invoiceData.vehicle.odometer}
                      </span>
                    </div>
                  </div>
                </div>
              );

            case "items":
              return (
                <div key={section.id} className="mb-8 overflow-x-auto">
                  <table className="w-full min-w-[500px]">
                    <thead>
                      <tr
                        className={styles.tableBorder}
                        style={{ borderColor: branding.primaryColor }}
                      >
                        <th className="text-left py-3 text-sm font-semibold">
                          Description
                        </th>
                        <th className="text-right py-3 text-sm font-semibold">
                          Qty
                        </th>
                        <th className="text-right py-3 text-sm font-semibold">
                          Rate
                        </th>
                        <th className="text-right py-3 text-sm font-semibold">
                          Amount
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {invoiceData.items.map((item, i) => (
                        <tr key={i} className="border-b border-gray-200">
                          <td className="py-3 text-sm">{item.description}</td>
                          <td className="text-right py-3 text-sm">
                            {item.quantity}
                          </td>
                          <td className="text-right py-3 text-sm">
                            ${item.rate.toFixed(2)}
                          </td>
                          <td className="text-right py-3 text-sm font-semibold">
                            ${item.amount.toFixed(2)}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              );

            case "totals":
              return (
                <div key={section.id} className="flex justify-end mb-8">
                  <div className="w-full sm:w-72">
                    <div className="flex justify-between py-2 text-sm">
                      <span className="text-gray-600">Subtotal:</span>
                      <span className="font-medium">
                        ${subtotal.toFixed(2)}
                      </span>
                    </div>
                    <div className="flex justify-between py-2 text-sm">
                      <span className="text-gray-600">Tax (10%):</span>
                      <span className="font-medium">${tax.toFixed(2)}</span>
                    </div>
                    <div
                      className="flex justify-between py-3 border-t-2 mt-2 font-bold text-lg sm:text-xl"
                      style={{
                        borderColor: branding.primaryColor,
                        color: branding.primaryColor,
                      }}
                    >
                      <span>Total:</span>
                      <span>${total.toFixed(2)}</span>
                    </div>
                  </div>
                </div>
              );

            case "notes":
              return (
                <div
                  key={section.id}
                  className="text-sm text-gray-600 border-t pt-6"
                >
                  <p className="font-semibold mb-2">Notes:</p>
                  <p>{invoiceData.notes}</p>
                </div>
              );

            default:
              return null;
          }
        };

        const renderTemplatePreview = () => {
          return (
            <div
              className="bg-white p-4 sm:p-8 rounded-lg invoice-preview shadow-lg"
              style={{ fontFamily: branding.font }}
            >
              {sections.map((section) => renderSection(section))}
            </div>
          );
        };

        if (loading) {
          return (
            <div className="min-h-screen flex items-center justify-center">
              <div className="text-center">
                <div className="text-4xl mb-4">‚è≥</div>
                <p className="text-gray-600">Loading templates...</p>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen">
            {/* Mobile Overlay */}
            <div
              className={`mobile-overlay ${sidebarOpen ? "open" : ""}`}
              onClick={() => setSidebarOpen(false)}
            ></div>

            {/* Header */}
            <div className="no-print bg-white border-b shadow-sm sticky top-0 z-50">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 py-4">
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-3">
                    <button
                      onClick={() => setSidebarOpen(!sidebarOpen)}
                      className="hamburger-menu lg:hidden p-2 hover:bg-gray-100 rounded"
                    >
                      <svg
                        className="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M4 6h16M4 12h16M4 18h16"
                        />
                      </svg>
                    </button>
                    <div>
                      <h1 className="text-xl sm:text-2xl font-bold">
                        Invoice Manager
                      </h1>
                      <p className="text-gray-600 text-xs sm:text-sm hidden sm:block">
                        Create professional invoices
                      </p>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={saveInvoiceForPreview}
                      className="px-3 sm:px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
                    >
                      üëÅÔ∏è <span className="hidden sm:inline">View</span>
                    </button>
                    <button
                      onClick={() => window.print()}
                      className="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
                    >
                      üñ®Ô∏è <span className="hidden sm:inline">Print</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div
              className="no-print border-b overflow-x-auto"
              style={{ background: "#c0c2c4" }}
            >
              <div className="max-w-7xl mx-auto px-4 sm:px-6">
                <div className="flex gap-1 min-w-max">
                  {["editor", "branding", "preview"].map((tab) => (
                    <button
                      key={tab}
                      onClick={() => setActiveTab(tab)}
                      className={`px-4 sm:px-6 py-3 font-medium text-sm whitespace-nowrap ${
                        activeTab === tab
                          ? "border-b-2 border-blue-600 text-blue-600"
                          : "text-gray-600"
                      }`}
                    >
                      {tab === "editor"
                        ? "‚úèÔ∏è Edit"
                        : tab === "branding"
                        ? "‚öôÔ∏è Branding"
                        : "üëÅÔ∏è Preview"}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            {/* Main Content */}
            <div className="max-w-full mx-1 px-1 sm:px-6 py-1 sm:py-8">
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-8">
                {/* Sidebar */}
                <div
                  className={`mobile-sidebar ${
                    sidebarOpen ? "open" : ""
                  } lg:col-span-1`}
                >
                  <div className="bg-gray-300 rounded-lg shadow-sm border p-4 sm:p-6 lg:sticky lg:top-4 max-h-[calc(100vh-120px)] overflow-y-auto">
                    {/* Close button for mobile */}
                    <button
                      onClick={() => setSidebarOpen(false)}
                      className="lg:hidden absolute top-4 right-4 text-gray-500 hover:text-gray-700"
                    >
                      <svg
                        className="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M6 18L18 6M6 6l12 12"
                        />
                      </svg>
                    </button>
                    {activeTab === "editor" && (
                      <div className="space-y-6">
                        <div>
                          <h3 className="text-lg font-semibold mb-4">
                            Invoice Details
                          </h3>

                          <label className="block text-sm font-medium mb-2">
                            Invoice Number
                          </label>
                          <input
                            type="text"
                            value={invoiceData.number}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                number: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-3 text-sm"
                          />

                          <label className="block text-sm font-medium mb-2">
                            Date
                          </label>
                          <input
                            type="date"
                            value={invoiceData.date}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                date: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-3 text-sm"
                          />

                          <label className="block text-sm font-medium mb-2">
                            Due Date
                          </label>
                          <input
                            type="date"
                            value={invoiceData.dueDate}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                dueDate: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-3 text-sm"
                          />

                          <label className="block text-sm font-medium mb-2">
                            Service Type
                          </label>
                          <input
                            type="text"
                            value={invoiceData.serviceType}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                serviceType: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-3 text-sm"
                          />

                          <label className="block text-sm font-medium mb-2">
                            Merchant Code
                          </label>
                          <input
                            type="text"
                            value={invoiceData.merchantCode}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                merchantCode: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-3 text-sm"
                          />
                        </div>

                        <div>
                          <h4 className="font-semibold mb-3">
                            Invoice To(Your Business)
                          </h4>
                          <input
                            type="text"
                            value={invoiceData.from.name}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                from: {
                                  ...invoiceData.from,
                                  name: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Business Name"
                          />
                          <input
                            type="text"
                            value={invoiceData.from.address}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                from: {
                                  ...invoiceData.from,
                                  address: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Address"
                          />
                          <input
                            type="text"
                            value={invoiceData.from.city}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                from: {
                                  ...invoiceData.from,
                                  city: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="City, State ZIP"
                          />
                          <input
                            type="email"
                            value={invoiceData.from.email}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                from: {
                                  ...invoiceData.from,
                                  email: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Email"
                          />
                          <input
                            type="tel"
                            value={invoiceData.from.phone}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                from: {
                                  ...invoiceData.from,
                                  phone: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg text-sm"
                            placeholder="Phone"
                          />
                        </div>

                        <div>
                          <h4 className="font-semibold mb-3">
                            Bill To (Client)
                          </h4>
                          <input
                            type="text"
                            value={invoiceData.to.name}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                to: { ...invoiceData.to, name: e.target.value },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Client Name"
                          />
                          <input
                            type="text"
                            value={invoiceData.to.address}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                to: {
                                  ...invoiceData.to,
                                  address: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Address"
                          />
                          <input
                            type="text"
                            value={invoiceData.to.city}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                to: { ...invoiceData.to, city: e.target.value },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="City, State ZIP"
                          />
                          <input
                            type="email"
                            value={invoiceData.to.email}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                to: {
                                  ...invoiceData.to,
                                  email: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Email"
                          />
                          <input
                            type="tel"
                            value={invoiceData.to.phone}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                to: {
                                  ...invoiceData.to,
                                  phone: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg text-sm"
                            placeholder="Phone"
                          />
                        </div>

                        <div>
                          <h4 className="font-semibold mb-3">
                            Vehicle Details
                          </h4>
                          <input
                            type="text"
                            value={invoiceData.vehicle.registration}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                vehicle: {
                                  ...invoiceData.vehicle,
                                  registration: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Registration"
                          />
                          <input
                            type="text"
                            value={invoiceData.vehicle.make}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                vehicle: {
                                  ...invoiceData.vehicle,
                                  make: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Make"
                          />
                          <input
                            type="text"
                            value={invoiceData.vehicle.model}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                vehicle: {
                                  ...invoiceData.vehicle,
                                  model: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-2 text-sm"
                            placeholder="Model"
                          />
                          <input
                            type="text"
                            value={invoiceData.vehicle.odometer}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                vehicle: {
                                  ...invoiceData.vehicle,
                                  odometer: e.target.value,
                                },
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg text-sm"
                            placeholder="Odometer"
                          />
                        </div>

                        <div>
                          <h4 className="font-semibold mb-3">Line Items</h4>
                          {invoiceData.items.map((item, i) => (
                            <div
                              key={i}
                              className="p-3 bg-gray-50 rounded border mb-2"
                            >
                              <input
                                type="text"
                                value={item.description}
                                onChange={(e) =>
                                  updateLineItem(
                                    i,
                                    "description",
                                    e.target.value
                                  )
                                }
                                className="w-full px-2 py-1 text-sm border rounded mb-2"
                                placeholder="Description"
                              />
                              <div className="grid grid-cols-4 gap-2">
                                <input
                                  type="number"
                                  value={item.quantity}
                                  onChange={(e) =>
                                    updateLineItem(
                                      i,
                                      "quantity",
                                      parseFloat(e.target.value) || 0
                                    )
                                  }
                                  className="px-2 py-1 text-sm border rounded"
                                  placeholder="Qty"
                                />
                                <input
                                  type="number"
                                  value={item.rate}
                                  onChange={(e) =>
                                    updateLineItem(
                                      i,
                                      "rate",
                                      parseFloat(e.target.value) || 0
                                    )
                                  }
                                  className="px-2 py-1 text-sm border rounded"
                                  placeholder="Rate"
                                />
                                <span className="text-xs font-medium flex items-center justify-center bg-white border rounded">
                                  ${item.amount.toFixed(2)}
                                </span>
                                <button
                                  onClick={() => removeLineItem(i)}
                                  className="text-red-600 text-xs hover:text-red-800 bg-red-50 rounded"
                                >
                                  Remove
                                </button>
                              </div>
                            </div>
                          ))}
                          <button
                            onClick={addLineItem}
                            className="w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 text-sm"
                          >
                            + Add Item
                          </button>
                        </div>

                        <div>
                          <label className="block text-sm font-medium mb-2">
                            Notes
                          </label>
                          <textarea
                            value={invoiceData.notes}
                            onChange={(e) =>
                              setInvoiceData({
                                ...invoiceData,
                                notes: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg text-sm"
                            rows="3"
                          />
                        </div>
                      </div>
                    )}

                    {activeTab === "branding" && (
                      <div className="space-y-6">
                        <div>
                          <h3 className="text-lg font-semibold mb-4">
                            Brand Settings
                          </h3>
                          <label className="block text-sm font-medium mb-2">
                            Select Saved Template
                          </label>
                          <select
                            value={selectedTemplate}
                            onChange={(e) => {
                              setSelectedTemplate(e.target.value);
                              loadAndApplyTemplate(e.target.value);
                            }}
                            className="w-full px-3 py-2 border rounded-lg mb-4"
                          >
                            <option value="null">Default Template</option>
                            {savedTemplates.map((template) => (
                              <option key={template.id} value={template.id}>
                                {template.name}
                              </option>
                            ))}
                          </select>
                          <p className="text-xs text-gray-500 mb-4">
                            Choose a saved template to apply custom styling
                          </p>

                          <label className="block text-sm font-medium mb-2">
                            Company Logo
                          </label>
                          <div className="flex items-center gap-4 mb-4">
                            {branding.logo ? (
                              <img
                                src={branding.logo}
                                alt="Logo"
                                className="h-20 w-20 object-contain border rounded p-2"
                              />
                            ) : (
                              <div className="h-20 w-20 border-2 border-dashed rounded flex items-center justify-center text-gray-400">
                                No Logo
                              </div>
                            )}
                            <label className="cursor-pointer px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                              Upload Logo
                              <input
                                type="file"
                                className="hidden"
                                accept="image/*"
                                onChange={handleLogoUpload}
                              />
                            </label>
                          </div>

                          <label className="block text-sm font-medium mb-2">
                            Company Name
                          </label>
                          <input
                            type="text"
                            value={branding.companyName}
                            onChange={(e) =>
                              setBranding({
                                ...branding,
                                companyName: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-4"
                          />

                          <label className="block text-sm font-medium mb-2">
                            Tagline
                          </label>
                          <input
                            type="text"
                            value={branding.tagline}
                            onChange={(e) =>
                              setBranding({
                                ...branding,
                                tagline: e.target.value,
                              })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-4"
                          />

                          <label className="block text-sm font-medium mb-2">
                            Primary Color
                          </label>
                          <div className="flex items-center gap-3 mb-4">
                            <input
                              type="color"
                              value={branding.primaryColor}
                              onChange={(e) =>
                                setBranding({
                                  ...branding,
                                  primaryColor: e.target.value,
                                })
                              }
                              className="h-10 w-20 border rounded cursor-pointer"
                            />
                            <input
                              type="text"
                              value={branding.primaryColor}
                              onChange={(e) =>
                                setBranding({
                                  ...branding,
                                  primaryColor: e.target.value,
                                })
                              }
                              className="flex-1 px-3 py-2 border rounded-lg font-mono text-sm"
                            />
                          </div>

                          <label className="block text-sm font-medium mb-2">
                            Font Style
                          </label>
                          <select
                            value={branding.font}
                            onChange={(e) =>
                              setBranding({ ...branding, font: e.target.value })
                            }
                            className="w-full px-3 py-2 border rounded-lg mb-4"
                          >
                            <option value="Inter, system-ui, sans-serif">
                              Sans Serif (Modern)
                            </option>
                            <option value="Georgia, serif">
                              Serif (Classic)
                            </option>
                          </select>
                        </div>

                        <div>
                          <h4 className="font-semibold mb-3">Section Order</h4>
                          <p className="text-sm text-gray-600 mb-3">
                            Drag to reorder sections
                          </p>
                          {sections.map((section, index) => (
                            <div
                              key={section.id}
                              draggable
                              onDragStart={(e) => handleDragStart(e, index)}
                              onDragEnd={handleDragEnd}
                              onDragOver={(e) => e.preventDefault()}
                              onDrop={(e) => handleDrop(e, index)}
                              className="flex items-center justify-between p-3 bg-white border rounded-lg cursor-move hover:border-blue-400 mb-2"
                            >
                              <span className="font-medium text-sm">
                                ‚ò∞ {section.name}
                              </span>
                              <label className="flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  checked={section.visible}
                                  onChange={(e) => {
                                    const newSections = [...sections];
                                    newSections[index].visible =
                                      e.target.checked;
                                    setSections(newSections);
                                  }}
                                  className="w-4 h-4"
                                />
                                <span className="text-sm text-gray-600">
                                  Show
                                </span>
                              </label>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {activeTab === "preview" && (
                      <div className="text-center">
                        <h3 className="text-lg font-semibold mb-4">
                          Preview Mode
                        </h3>
                        <p className="text-sm text-gray-600 mb-4">
                          Your invoice is displayed on the right. Click Print to
                          save as PDF.
                        </p>
                        <button
                          onClick={() => window.print()}
                          className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        >
                          üñ®Ô∏è Print / Save PDF
                        </button>
                      </div>
                    )}
                  </div>
                </div>

                {/* Preview */}
                <div className="lg:col-span-2">
                  <div
                    ref={containerRef}
                    className="relative flex flex-col lg:flex-row gap-0"
                  >
                    {/* Invoice Preview */}
                    <div
                      className="overflow-y-auto"
                      style={{
                        width:
                          window.innerWidth >= 1024 ? `${leftWidth}%` : "100%",
                      }}
                    >
                      <div
                        className="bg-white p-8 rounded-lg shadow-lg invoice-preview"
                        style={{ fontFamily: branding.font }}
                      >
                        {sections.map((section) => renderSection(section))}
                      </div>
                    </div>

                    {/* Resizer - only visible on large screens */}

                    <div
                      className={`hidden lg:block w-1 bg-gray-300 print:hidden hover:bg-gray-500 cursor-col-resize transition-colors ${
                        isResizing ? "bg-gray-500" : ""
                      }`}
                      onMouseDown={handleMouseDown}
                    >
                     
                    </div>
                    {/* Saved Templates */}
                    <div
                      className="overflow-y-auto print:hidden mt-6 lg:mt-0"
                      style={{
                        width:
                          window.innerWidth >= 1024
                            ? `${100 - leftWidth}%`
                            : "100%",
                      }}
                    >
                      <div className="bg-white rounded-lg shadow-sm border p-6">
                        <h3 className="text-lg font-semibold mb-4">
                          Saved Templates
                        </h3>

                        {savedTemplates.length === 0 ? (
                          <p className="text-sm text-gray-500">
                            No saved templates yet
                          </p>
                        ) : (
                          <div className="space-y-2">
                            {savedTemplates.map((template) => (
                              <div
                                key={template.id}
                                className="p-3 bg-gray-50 rounded border"
                              >
                                <div className="flex justify-between items-start mb-2">
                                  <div>
                                    <span className="font-medium text-sm block">
                                      {template.name}
                                    </span>
                                    <span className="text-xs text-gray-500">
                                      {templates.find(
                                        (t) => t.id === template.templateType
                                      )?.name || template.templateType}
                                    </span>
                                  </div>
                                  <button
                                    onClick={() => deleteTemplate(template.id)}
                                    className="text-red-600 text-xs hover:text-red-800"
                                  >
                                    ‚úï
                                  </button>
                                </div>
                                <div className="flex gap-2">
                                  <button
                                    onClick={() => loadTemplate(template.id)}
                                    className="flex-1 px-3 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200"
                                  >
                                    Load to Editor
                                  </button>
                                  <button
                                    onClick={() =>
                                      loadAndViewTemplate(template.id)
                                    }
                                    className="flex-1 px-3 py-1 bg-green-100 text-green-700 rounded text-xs hover:bg-green-200"
                                  >
                                    View Invoice
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(
        <InvoiceManager />
      );
    </script>
    <script>
      // Calculate net price for a row
      function calculateRow(input) {
        const row = input.closest("tr");
        const qty = parseFloat(row.querySelector(".item-qty").value) || 0;
        const price = parseFloat(row.querySelector(".item-price").value) || 0;
        const netPrice = qty * price;

        row.querySelector(".net-price").textContent =
          "R " + netPrice.toFixed(2);
        calculateTotals();
      }

      // Calculate all totals
      function calculateTotals() {
        let subtotal = 0;
        document.querySelectorAll(".item-row").forEach((row) => {
          const qty = parseFloat(row.querySelector(".item-qty").value) || 0;
          const price = parseFloat(row.querySelector(".item-price").value) || 0;
          subtotal += qty * price;
        });

        const vat = subtotal * 0;
        const total = subtotal + vat;

        document.getElementById("subtotal").textContent =
          "R " + subtotal.toFixed(2);
        document.getElementById("vat").textContent = "R " + vat.toFixed(2);
        document.getElementById("total").textContent = "R " + total.toFixed(2);
      }

      // Add new row
      function addRow() {
        const tbody = document.getElementById("itemsBody");
        const newRow = document.createElement("tr");
        newRow.className = "item-row";
        newRow.innerHTML = `
        <td><input type="text" class="item-desc" placeholder="Item description"></td>
        <td class="text-center"><input type="number" class="item-qty" value="1" min="0" step="1" onchange="calculateRow(this)"></td>
        <td class="text-right"><input type="number" class="item-price" value="0.00" min="0" step="0.01" onchange="calculateRow(this)"></td>
        <td class="text-right"><span class="net-price">R 0.00</span></td>
        <td class="text-center"><button class="btn-remove" onclick="removeRow(this)">Remove</button></td>
    `;
        tbody.appendChild(newRow);
        calculateTotals();
      }

      // Remove row
      function removeRow(button) {
        if (document.querySelectorAll(".item-row").length > 1) {
          button.closest("tr").remove();
          calculateTotals();
        } else {
          alert("You must have at least one item.");
        }
      }

      class InvoiceCounter {
        constructor() {
          this.counter = 1; // Start at 1
          this.prefix = "INV";
        }

        // Generate invoice number with current counter
        generate() {
          const year = new Date().getFullYear();
          const paddedNum = String(this.counter).padStart(3, "0");
          return `${this.prefix}-${year}-${paddedNum}`;
        }

        // Get current invoice number without incrementing
        getCurrent() {
          return this.generate();
        }

        // Get next invoice number and increment counter
        getNext() {
          this.counter++;
          return this.generate();
        }

        // Set counter to specific number
        setCounter(num) {
          this.counter = Math.max(1, parseInt(num) || 1);
        }

        // Parse and update counter from existing invoice number
        parseAndUpdate(invoiceNo) {
          const match = invoiceNo.match(/INV-\d{4}-(\d+)/);
          if (match) {
            const num = parseInt(match[1], 10);
            if (num >= this.counter) {
              this.counter = num + 1;
            }
          }
        }
      }

      // Create global instance
      const invoiceCounter = new InvoiceCounter();

      // Initialize invoice system
      document.addEventListener("DOMContentLoaded", function () {
        const invoiceNumberInput = document.getElementById("invoiceNumber");

        // Set initial invoice number
        invoiceNumberInput.value = invoiceCounter.getCurrent();

        
        const newInvoiceBtn = document.getElementById("newInvoiceBtn");
        if (newInvoiceBtn) {
          newInvoiceBtn.addEventListener("click", function () {
            // Clear form and set new invoice number
            const newInvoiceNo = invoiceCounter.getNext();
            invoiceNumberInput.value = newInvoiceNo;
            console.log("New invoice:", newInvoiceNo);
          });
        }

        // Hook into "Save Invoice" button
        const saveBtn = document.getElementById("saveInvoice");
        if (saveBtn) {
          saveBtn.addEventListener("click", function () {
            console.log("Saved invoice:", invoiceNumberInput.value);

            // After saving, prepare next invoice number
            setTimeout(() => {
              const nextInvoiceNo = invoiceCounter.getNext();
              invoiceNumberInput.value = nextInvoiceNo;
              console.log("Ready for next invoice:", nextInvoiceNo);
            }, 1000);
          });
        }

        // Optional: Allow manual editing and sync counter
        invoiceNumberInput.addEventListener("blur", function () {
          invoiceCounter.parseAndUpdate(this.value);
        });
      });

      // Export for use in other scripts
      window.invoiceCounter = invoiceCounter;
      // Create new invoice
      function createNew() {
        if (
          confirm(
            "Are you sure you want to create a new invoice? All current data will be cleared."
          )
        ) {
          const nextInvoiceNo = getNextInvoiceNumber();
          localStorage.setItem("lastInvoiceNo", nextInvoiceNo);
          location.reload();
        }
      }

      // Save as PDF
      function savePDF() {
        window.print();
      }
      function initializeInvoice() {
        // Load last invoice number and increment
        const lastInvoiceNo = localStorage.getItem("lastInvoiceNo");
        if (lastInvoiceNo) {
          document.getElementById("invoiceNumber").value = lastInvoiceNo;
        } else {
          // First time, set initial value
          const year = new Date().getFullYear();
          document.getElementById("invoiceNumber").value = `INV-${year}-001`;
        }

        // Set today's date
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("invoiceDate").value = today;

        calculateTotals();
      }

      initializeInvoice();
      // Initialize
      calculateTotals();

      const overlay = document.getElementById("sidebarOverlay");
      overlay.addEventListener("click", () => {
        sidebar.classList.remove("open");
        sidebar.setAttribute("aria-hidden", true);
      });
    </script>
    <script
      type="text/javascript"
      src="https://assets.calendly.com/assets/external/widget.js"
      async
    ></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
      // Wait for Firebase to be fully initialized before using it
      let firebaseReady = false;

      // Initialize Firebase and set ready flag
      function initializeFirebaseApp() {
        const firebaseConfig = {
          apiKey: "AIzaSyD1Xzk2DL-kuxEMgbomupgAF0IQZWso8PQ",
          authDomain: "solidflow-1f753.firebaseapp.com",
          projectId: "solidflow-1f753",
          storageBucket: "solidflow-1f753.firebasestorage.app",
          messagingSenderId: "68885400864",
          appId: "1:68885400864:web:7788e19a073d9a8e79db45",
          measurementId: "G-RTL0CM1B44",
        };

        // Initialize Firebase only if not already initialized
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }

        firebaseReady = true;
        console.log("Firebase initialized successfully");
      }

      // Function to get the next invoice number from Firebase
      async function getNextInvoiceNumber() {
        // Fallback helper
        const getFallbackNumber = () => {
          const year = new Date().getFullYear();
          return `INV-${year}-001`;
        };

        if (!firebaseReady) {
          console.error("Firebase not ready yet");
          return getFallbackNumber();
        }

        const user = firebase.auth().currentUser;
        if (!user) {
          console.error("No user logged in");
          return getFallbackNumber();
        }

        const userId = user.uid;
        const year = new Date().getFullYear();

        try {
          const db = firebase.firestore();
          const invoicesRef = db
            .collection("users")
            .doc(userId)
            .collection("invoices");

          // Query last invoice for current year (more efficient)
          const yearStart = `INV-${year}-000`;
          const yearEnd = `INV-${year}-999`;

          const snapshot = await invoicesRef
            .where("invoiceNumber", ">=", yearStart)
            .where("invoiceNumber", "<=", yearEnd)
            .orderBy("invoiceNumber", "desc")
            .limit(1)
            .get();

          let nextNumber = 1;

          if (!snapshot.empty) {
            const lastInvoice = snapshot.docs[0].data();
            const lastInvoiceNumber = lastInvoice.invoiceNumber;

            console.log("Last invoice found:", lastInvoiceNumber);

            // Extract the numeric part
            const match = lastInvoiceNumber.match(/INV-(\d{4})-(\d{3})/);

            if (match) {
              const lastYear = parseInt(match[1]);
              const lastNumber = parseInt(match[2]);

              // Should always be current year due to query filter
              if (lastYear === year) {
                nextNumber = lastNumber + 1;
              }
            }
          } else {
            console.log(
              "No existing invoices found for",
              year,
              "- starting with 001"
            );
          }

          // Format: INV-YYYY-XXX
          const paddedNumber = String(nextNumber).padStart(3, "0");
          const newInvoiceNumber = `INV-${year}-${paddedNumber}`;

          console.log("Generated invoice number:", newInvoiceNumber);
          return newInvoiceNumber;
        } catch (error) {
          console.error("Error fetching last invoice:", error);
          return getFallbackNumber();
        }
      }

      // Load invoice data from Firestore when page loads
async function loadInvoiceFromFirestore() {
  const invoiceNumber = sessionStorage.getItem("loadInvoiceNumber");
  
  if (!invoiceNumber) {
    console.log("No invoice to load");
    return;
  }

  const user = firebase.auth().currentUser;
  if (!user) {
    console.error("No user logged in");
    return;
  }

  try {
    // Query for the invoice by invoiceNumber
    const snapshot = await firebase.firestore()
      .collection("users")
      .doc(user.uid)
      .collection("invoices")
      .where("invoiceNumber", "==", invoiceNumber)
      .limit(1)
      .get();

    if (snapshot.empty) {
      console.error("Invoice not found:", invoiceNumber);
      alert("Invoice not found!");
      sessionStorage.removeItem("loadInvoiceNumber");
      return;
    }

    // Get the invoice data
    const invoiceDoc = snapshot.docs[0];
    const invoiceData = invoiceDoc.data();
    
    console.log("Loading invoice data:", invoiceData);

    // Populate the form fields
    document.getElementById("invoiceNumber").value = invoiceData.invoiceNumber || "";
    document.getElementById("invoiceDate").value = invoiceData.invoiceDate || "";
    document.getElementById("merchantCode").value = invoiceData.merchantCode || "";
    document.getElementById("serviceType").value = invoiceData.serviceType || "";
    
    // Client information
    document.getElementById("clientName").value = invoiceData.clientName || "";
    document.getElementById("clientAddress").value = invoiceData.clientAddress || "";
    document.getElementById("clientContact").value = invoiceData.clientContact || "";
    
    // Vehicle/Job information (if you have these fields)
    if (document.getElementById("vehicleMake")) {
      document.getElementById("vehicleMake").value = invoiceData.vehicleMake || "";
    }
    if (document.getElementById("vehicleModel")) {
      document.getElementById("vehicleModel").value = invoiceData.vehicleModel || "";
    }
    if (document.getElementById("vehicleReg")) {
      document.getElementById("vehicleReg").value = invoiceData.vehicleReg || "";
    }
    if (document.getElementById("vehicleVin")) {
      document.getElementById("vehicleVin").value = invoiceData.vehicleVin || "";
    }
    if (document.getElementById("mileage")) {
      document.getElementById("mileage").value = invoiceData.mileage || "";
    }

    // Load line items
    if (invoiceData.items && invoiceData.items.length > 0) {
      // Clear existing items first
      const itemsTableBody = document.getElementById("itemsTableBody");
      itemsTableBody.innerHTML = "";
      
      // Add each item
      invoiceData.items.forEach((item, index) => {
        addItemRow(); // Add a new row
        
        // Get the newly added row
        const rows = itemsTableBody.getElementsByTagName("tr");
        const newRow = rows[rows.length - 1];
        
        // Populate the row with data
        newRow.querySelector('input[placeholder="Description"]').value = item.description || "";
        newRow.querySelector('input[placeholder="Qty"]').value = item.qty || 0;
        newRow.querySelector('input[placeholder="Unit Price"]').value = item.unitPrice || 0;
        newRow.querySelector('input[placeholder="Discount %"]').value = item.discount || 0;
      });
    }

    // Load notes and terms
    if (document.getElementById("notes")) {
      document.getElementById("notes").value = invoiceData.notes || "";
    }
    if (document.getElementById("terms")) {
      document.getElementById("terms").value = invoiceData.terms || "";
    }

    // Recalculate totals
    if (typeof calculateTotals === 'function') {
      calculateTotals();
    }

    // Clear the session storage
    sessionStorage.removeItem("loadInvoiceNumber");
    
    alert("Invoice loaded successfully!");

  } catch (error) {
    console.error("Error loading invoice:", error);
    alert("Error loading invoice: " + error.message);
  }
}
function loadUserProfile(user) {
  db.collection("users").doc(user.uid).get()
    .then((doc) => {
      if (doc.exists) {
        const userData = doc.data();
        // Update profile display if you have these elements
        const profileName = document.querySelector('.flex div:last-child div:first-child');
        const profileRole = document.querySelector('.flex div:last-child div:last-child');
        
        if (profileName) {
          profileName.textContent = userData.name || 'User';
        }
        if (profileRole) {
          profileRole.textContent = (userData.role || 'user').charAt(0).toUpperCase() + (userData.role || 'user').slice(1);
        }
      }
    })
    .catch((error) => {
      console.error("Error loading profile:", error);
    });
}
// Call this function when the invoice page loads
firebase.auth().onAuthStateChanged((user) => {
  if (user) {
   currentUserId = user.uid;
    firebaseReady = true;
    
    // Load user profile
    loadUserProfile(user);
    
    // Load invoices
    displayInvoicesTable();
    const invoiceToLoad = sessionStorage.getItem("loadInvoiceNumber");
    if (invoiceToLoad) {
      loadInvoiceFromFirestore();
    }
  }
});
      async function initializeInvoiceNumber() {
        const invoiceInput = document.getElementById("invoiceNumber");

        if (!invoiceInput) {
          console.error("Invoice number input not found");
          return;
        }

        // Show loading state
        invoiceInput.value = "Loading...";
        invoiceInput.disabled = true;

        try {
          const newInvoiceNumber = await getNextInvoiceNumber();
          invoiceInput.value = newInvoiceNumber;
        } catch (error) {
          console.error("Error initializing invoice:", error);
          const year = new Date().getFullYear();
          invoiceInput.value = `INV-${year}-001`;
        } finally {
          invoiceInput.disabled = false;
        }
      }

     
        async function saveInvoiceToFirebase() {
      console.log("üíæ Attempting to save invoice...");

      // Helper to wait for firebaseReady flag
      function waitForFirebaseReady(timeoutMs = 5000) {
        return new Promise((resolve, reject) => {
        const start = Date.now();
        (function check() {
          if (firebaseReady) return resolve();
          if (Date.now() - start > timeoutMs) return reject(new Error('timeout'));
          setTimeout(check, 100);
        })();
        });
      }

      if (!firebaseReady) {
        console.log('Firebase not ready yet ‚Äî attempting to initialize now');
        try {
          initializeFirebaseApp();
          await waitForFirebaseReady(5000);
        } catch (err) {
          console.error('Firebase failed to initialize in time', err);
        }
      }

      if (!firebaseReady) {
        alert("Firebase is not initialized yet. Please wait a moment and try again.");
        return;
      }

      const user = firebase.auth().currentUser;
      if (!user) {
        alert("You must be logged in to save an invoice.");
        return;
      }

      const userId = user.uid;
      const invoiceNumber = document.getElementById("invoiceNumber").value;

      if (!invoiceNumber || invoiceNumber === "Loading..." || invoiceNumber === "Error loading") {
        alert("Please wait for invoice number to load");
        return;
      }

      // Check if invoice already exists
      try {
        const db = firebase.firestore();
        const docRef = db
          .collection("users")
          .doc(userId)
          .collection("invoices")
          .doc(invoiceNumber);

        const docSnapshot = await docRef.get();

        if (docSnapshot.exists) {
          alert(`Invoice ${invoiceNumber} has already been saved. Please create a new invoice using the "New Invoice" button.`);
          return;
        }
      } catch (error) {
        console.error("Error checking if invoice exists:", error);
        alert("Error checking invoice: " + error.message);
        return;
      }

      // Collect invoice data
      const invoiceData = {
        invoiceNumber: invoiceNumber,
        invoiceDate: document.getElementById("invoiceDate").value,
        merchantCode: document.getElementById("merchantCode").value,
        serviceType: document.getElementById("serviceType").value,
        clientName: document.getElementById("clientName").value,
        emailAddress: document.getElementById("emailAddress").value,
        clientInfo: document.getElementById("clientInfo").value,
        regNumber: document.getElementById("regNumber").value,
        make: document.getElementById("make").value,
        model: document.getElementById("model").value,
        engine: document.getElementById("engine").value,
        vinNumber: document.getElementById("vinNumber").value,
        odometer: document.getElementById("odometer").value,
        preAuth: document.getElementById("preAuth").value,
        authCode: document.getElementById("authCode").value,
        items: Array.from(document.querySelectorAll("#itemsBody tr.item-row")).map((row) => ({
          description: row.querySelector(".item-desc").value,
          quantity: parseFloat(row.querySelector(".item-qty").value),
          unitPrice: parseFloat(row.querySelector(".item-price").value),
          netPrice: parseFloat(row.querySelector(".net-price").textContent.replace(/[^\d\.]/g, ""))
        })),
        subtotal: document.getElementById("subtotal").textContent,
        vat: document.getElementById("vat").textContent,
        total: document.getElementById("total").textContent,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // Save to Firebase - THIS IS THE ACTUAL SAVE
      try {
        const db = firebase.firestore();
        await db
          .collection("users")
          .doc(userId)
          .collection("invoices")
          .doc(invoiceData.invoiceNumber)
          .set(invoiceData);

        // SUCCESS - Now we can celebrate
        console.log("‚úÖ Invoice saved successfully:", invoiceData.invoiceNumber);
        alert("Invoice saved successfully!");

        // Generate next invoice number
        await initializeInvoiceNumber();

        // Clear form fields
        clearInvoiceFormFields();

      } catch (error) {
        console.error("‚ùå Error saving invoice:", error);
        alert("Failed to save invoice: " + error.message);
      }
    }

    function addItemRow() {
  const tbody = document.getElementById("itemsTableBody");
  const newRow = document.createElement("tr");
  
  newRow.innerHTML = `
    <td><input type="text" placeholder="Description" oninput="calculateTotals()" /></td>
    <td><input type="number" placeholder="Qty" value="1" oninput="calculateTotals()" /></td>
    <td><input type="number" placeholder="Unit Price" value="0" oninput="calculateTotals()" /></td>
    <td><input type="number" placeholder="Discount %" value="0" oninput="calculateTotals()" /></td>
    <td class="net-price">R 0.00</td>
    <td style="text-align: center;">
      <button type="button" class="btn-remove" onclick="removeItemRow(this)">√ó</button>
    </td>
  `;
  
  tbody.appendChild(newRow);
  calculateTotals();
}      
function clearInvoiceFormFields() {
  // Clear all fields EXCEPT invoice number (which was just initialized)
  document.getElementById("clientName").value = "";
  document.getElementById("emailAddress").value = "";
  document.getElementById("clientInfo").value = "";
  document.getElementById("regNumber").value = "";
  document.getElementById("make").value = "";
  document.getElementById("model").value = "";
  document.getElementById("engine").value = "";
  document.getElementById("vinNumber").value = "";
  document.getElementById("odometer").value = "";
  document.getElementById("preAuth").value = "";
  document.getElementById("authCode").value = ""; 
  document.getElementById("itemsBody").innerHTML = "";
  addItemRow(); // Add one empty row
}
      // Function to create new invoice (clears form and gets next number)
      async function createNewInvoice() {
        if (
          confirm(
            "Are you sure you want to create a new invoice? All current data will be cleared."
          )
        ) {
          // Clear all inputs
          document.getElementById("clientName").value = "";
          document.getElementById("emailAddress").value = "";
          document.getElementById("clientInfo").value = "";
          document.getElementById("regNumber").value = "";
          document.getElementById("make").value = "";
          document.getElementById("model").value = "";
          document.getElementById("engine").value = "";
          document.getElementById("vinNumber").value = "";
          document.getElementById("odometer").value = "";
          document.getElementById("preAuth").value = "";
          document.getElementById("authCode").value = "";

          // Clear items except first row
          const itemsBody = document.getElementById("itemsBody");
          while (itemsBody.children.length > 1) {
            itemsBody.removeChild(itemsBody.lastChild);
          }

          // Clear first row
          const firstRow = itemsBody.querySelector(".item-row");
          if (firstRow) {
            firstRow.querySelector(".item-desc").value = "";
            firstRow.querySelector(".item-qty").value = "1";
            firstRow.querySelector(".item-price").value = "0.00";
          }

          // Get next invoice number
          await initializeInvoiceNumber();

          // Reset date to today
          const today = new Date().toISOString().split("T")[0];
          document.getElementById("invoiceDate").value = today;

          calculateTotals();
        }
      }

      // Initialize when DOM is ready
      document.addEventListener("DOMContentLoaded", async function () {
        // Initialize Firebase first
        initializeFirebaseApp();

        // Wait a bit for Firebase to fully initialize
        setTimeout(async () => {
          await initializeInvoiceNumber();
        }, 1000);

        // Set today's date
        const today = new Date().toISOString().split("T")[0];
        const invoiceDateInput = document.getElementById("invoiceDate");
        if (invoiceDateInput && !invoiceDateInput.value) {
          invoiceDateInput.value = today;
        }

        calculateTotals();
      });
    </script>
    <script>
      // Example total calculator ‚Äî replace with your own logic
      function calculateTotalAmount() {
        const totalElement = document.getElementById("totalAmount");
        return parseFloat(totalElement?.value || 0);
      }
      const sidebarEl = document.getElementById("sidebar");
      const hambtn = document.getElementById("hambtn");
      const closeBtn = document.getElementById("closeSidebar");
      hambtn.addEventListener("click", () =>
        sidebarEl.classList.toggle("open")
      );
      closeBtn.addEventListener("click", () => {
        sidebar.classList.remove("open");
        sidebar.setAttribute("aria-hidden", "true");
      });
      document.addEventListener("click", (e) => {
        if (window.innerWidth <= 820) {
          const inside =
            sidebarEl.contains(e.target) ||
            hambtn.contains(e.target) ||
            document.getElementById("settingsDrawer").contains(e.target);
          if (!inside) sidebarEl.classList.remove("open");
        }
      });
      document.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        return false;
      });

      // Disable keyboard shortcuts (optional - prevents Ctrl+S, Ctrl+U, etc.)
      document.addEventListener("keydown", (e) => {
        // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
        if (
          e.keyCode === 123 || // F12
          (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
          (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
          (e.ctrlKey && e.keyCode === 85)
        ) {
          // Ctrl+U
          e.preventDefault();
          return false;
        }
      });
    </script>
    <script>
    function updateBankDetails() {
      const selectedValue = document.getElementById('merchantCode').value;
      document.getElementById('bank-811371').style.display = 'none';
      document.getElementById('bank-807411').style.display = 'none';
      document.getElementById('bank-' + selectedValue).style.display = 'block';
    }
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  </body>
</html>