<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invoice Template Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        deleteDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      // ========================================
      // 1. FIREBASE CONFIGURATION
      // ========================================
      const firebaseConfig = {
        apiKey: "AIzaSyD1Xzk2DL-kuxEMgbomupgAF0IQZWso8PQ",
        authDomain: "solidflow-1f753.firebaseapp.com",
        projectId: "solidflow-1f753",
        storageBucket: "solidflow-1f753.firebasestorage.app",
        messagingSenderId: "68885400864",
        appId: "1:68885400864:web:7788e19a073d9a8e79db45",
        measurementId: "G-RTL0CM1B44",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // ========================================
      // 2. TEMPLATE SERVICE
      // ========================================
      const templateService = {
        async saveTemplate(userId, templateData) {
          try {
            const templateRef = doc(
              collection(db, "users", userId, "invoiceTemplates")
            );

            const template = {
              ...templateData,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp(),
            };

            await setDoc(templateRef, template);
            return { success: true, id: templateRef.id };
          } catch (error) {
            console.error("Error saving template:", error);
            return { success: false, error: error.message };
          }
        },

        async updateTemplate(userId, templateId, templateData) {
          try {
            const templateRef = doc(
              db,
              "users",
              userId,
              "invoiceTemplates",
              templateId
            );
            await updateDoc(templateRef, {
              ...templateData,
              updatedAt: serverTimestamp(),
            });
            return { success: true };
          } catch (error) {
            console.error("Error updating template:", error);
            return { success: false, error: error.message };
          }
        },

        async getTemplate(userId, templateId) {
          try {
            const templateRef = doc(
              db,
              "users",
              userId,
              "invoiceTemplates",
              templateId
            );
            const templateSnap = await getDoc(templateRef);

            if (templateSnap.exists()) {
              return {
                success: true,
                data: { id: templateSnap.id, ...templateSnap.data() },
              };
            } else {
              return { success: false, error: "Template not found" };
            }
          } catch (error) {
            console.error("Error getting template:", error);
            return { success: false, error: error.message };
          }
        },

        async getUserTemplates(userId) {
          try {
            const templatesRef = collection(
              db,
              "users",
              userId,
              "invoiceTemplates"
            );
            const querySnapshot = await getDocs(templatesRef);

            const templates = [];
            querySnapshot.forEach((doc) => {
              templates.push({ id: doc.id, ...doc.data() });
            });

            return { success: true, data: templates };
          } catch (error) {
            console.error("Error getting user templates:", error);
            return { success: false, error: error.message };
          }
        },

        async deleteTemplate(userId, templateId) {
          try {
            await deleteDoc(
              doc(db, "users", userId, "invoiceTemplates", templateId)
            );
            return { success: true };
          } catch (error) {
            console.error("Error deleting template:", error);
            return { success: false, error: error.message };
          }
        },
      };

      // ========================================
      // 3. APPLICATION STATE
      // ========================================
      let currentUser = null;
      let templates = [];
      let selectedTemplate = null;

      // Default invoice data (will be replaced by template data)
      let invoiceData = {
        number: "INV-001",
        date: "2024-01-15",
        dueDate: "2024-02-15",
        from: {
          name: "Your Business Ltd",
          address: "123 Business Street",
          city: "Pretoria, Gauteng, 0001",
          email: "hello@yourbusiness.com",
          phone: "+27 (012) 987-6543",
        },
        to: {
          name: "Client Company",
          address: "456 Client Avenue",
          city: "Johannesburg, Gauteng, 2000",
          email: "client@email.com",
          phone: "+27 (011) 123-4567",
        },
        vehicle: {
          registration: "ABC123",
          make: "Toyota",
          model: "Camry",
          year: "2020",
          vin: "1HGBH41JXMN109186",
          odometer: "45000 miles",
        },
        items: [
          {
            description: "Oil Change",
            quantity: 1,
            rate: 50.0,
            amount: 50.0,
          },
        ],
        notes: "Thank you for your business!",
      };

      let branding = {
        logo: null,
        primaryColor: "#2563eb",
        tagline: "Quality Auto Repair Services",
      };

      // ========================================
      // 4. UI FUNCTIONS
      // ========================================
      function showLoading(show) {
        const loader = document.getElementById("loader");
        if (loader) {
          loader.style.display = show ? "block" : "none";
        }
      }

      function showMessage(message, type = "info") {
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = message;
        messageDiv.className = `p-4 rounded mb-4 ${
          type === "error"
            ? "bg-red-100 text-red-700"
            : type === "success"
            ? "bg-green-100 text-green-700"
            : "bg-blue-100 text-blue-700"
        }`;
        messageDiv.style.display = "block";

        setTimeout(() => {
          messageDiv.style.display = "none";
        }, 3000);
      }

      async function loadTemplates() {
        if (!currentUser) {
          showMessage("Please wait for authentication...", "info");
          return;
        }

        showLoading(true);
        const result = await templateService.getUserTemplates(currentUser.uid);

        if (result.success) {
          templates = result.data;
          renderTemplatesList();
          showMessage(`Loaded ${templates.length} template(s)`, "success");
        } else {
          showMessage("Failed to load templates: " + result.error, "error");
        }
        showLoading(false);
      }

      function renderTemplatesList() {
        const container = document.getElementById("templatesList");

        if (templates.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500">No saved templates yet. Save your first template to get started!</p>';
          return;
        }

        container.innerHTML = templates
          .map(
            (template) => `
        <div class="border rounded-lg p-4 shadow hover:shadow-lg transition-shadow">
          <h4 class="font-bold text-lg mb-2">${
            template.name || "Untitled Template"
          }</h4>
          <p class="text-sm text-gray-600 mb-2">${
            template.description || "No description"
          }</p>
          <p class="text-xs text-gray-500 mb-4">
            Updated: ${
              template.updatedAt?.seconds
                ? new Date(
                    template.updatedAt.seconds * 1000
                  ).toLocaleDateString()
                : "Unknown"
            }
          </p>
          
          <div class="flex gap-2">
            <button
              onclick="window.loadTemplate('${template.id}')"
              class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700"
            >
              Load
            </button>
            <button
              onclick="window.updateTemplate('${template.id}')"
              class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700"
            >
              Update
            </button>
            <button
              onclick="window.deleteTemplate('${template.id}')"
              class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700"
            >
              Delete
            </button>
          </div>
        </div>
      `
          )
          .join("");
      }

      async function saveCurrentAsTemplate() {
        if (!currentUser) {
          showMessage("Please wait for authentication...", "error");
          return;
        }

        const templateName = prompt("Enter a name for this template:");
        if (!templateName) return;

        const templateDescription = prompt("Enter a description (optional):");

        showLoading(true);
        const templateData = {
          name: templateName,
          description: templateDescription || "",
          type: "mechanics",
          invoiceData,
          branding,
        };

        const result = await templateService.saveTemplate(
          currentUser.uid,
          templateData
        );

        if (result.success) {
          showMessage("Template saved successfully!", "success");
          await loadTemplates();
        } else {
          showMessage("Failed to save template: " + result.error, "error");
        }
        showLoading(false);
      }

      async function loadTemplate(templateId) {
        if (!currentUser) {
          showMessage("Please authenticate first", "error");
          return;
        }

        showLoading(true);
        const result = await templateService.getTemplate(
          currentUser.uid,
          templateId
        );

        if (result.success) {
          const template = result.data;

          // Load invoice data from template
          if (template.invoiceData) {
            invoiceData = template.invoiceData;
          }

          // Load branding from template
          if (template.branding) {
            branding = template.branding;
          }

          selectedTemplate = template;
          showMessage(
            `Template "${template.name}" loaded successfully!`,
            "success"
          );
          renderInvoicePreview();
        } else {
          showMessage("Failed to load template: " + result.error, "error");
        }
        showLoading(false);
      }

      async function updateTemplate(templateId) {
        if (!currentUser) {
          showMessage("Please authenticate first", "error");
          return;
        }

        showLoading(true);
        const templateData = {
          invoiceData,
          branding,
        };

        const result = await templateService.updateTemplate(
          currentUser.uid,
          templateId,
          templateData
        );

        if (result.success) {
          showMessage("Template updated successfully!", "success");
          await loadTemplates();
        } else {
          showMessage("Failed to update template: " + result.error, "error");
        }
        showLoading(false);
      }

      async function deleteTemplate(templateId) {
        if (!currentUser) {
          showMessage("Please authenticate first", "error");
          return;
        }

        if (!confirm("Are you sure you want to delete this template?")) return;

        showLoading(true);
        const result = await templateService.deleteTemplate(
          currentUser.uid,
          templateId
        );

        if (result.success) {
          showMessage("Template deleted successfully!", "success");
          await loadTemplates();
          if (selectedTemplate?.id === templateId) {
            selectedTemplate = null;
            // Reset to default data
            invoiceData = {
              number: "INV-001",
              date: new Date().toISOString().split("T")[0],
              dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
                .toISOString()
                .split("T")[0],
              from: {
                name: "Your Business Ltd",
                address: "123 Business Street",
                city: "Pretoria, Gauteng, 0001",
                email: "hello@yourbusiness.com",
                phone: "+27 (012) 987-6543",
              },
              to: {
                name: "Client Company",
                address: "456 Client Avenue",
                city: "Johannesburg, Gauteng, 2000",
                email: "client@email.com",
                phone: "+27 (011) 123-4567",
              },
              vehicle: {
                registration: "ABC123",
                make: "Toyota",
                model: "Camry",
                year: "2020",
                vin: "1HGBH41JXMN109186",
                odometer: "45000 miles",
              },
              items: [
                {
                  description: "Service Item",
                  quantity: 1,
                  rate: 0,
                  amount: 0,
                },
              ],
              notes: "Thank you for your business!",
            };
            branding = {
              logo: null,
              primaryColor: "#2563eb",
              tagline: "Quality Auto Repair Services",
            };
            renderInvoicePreview();
          }
        } else {
          showMessage("Failed to delete template: " + result.error, "error");
        }
        showLoading(false);
      }

      function renderInvoicePreview() {
        const container = document.getElementById("invoicePreview");
        const subtotal = invoiceData.items.reduce(
          (sum, item) => sum + item.amount,
          0
        );
        const tax = subtotal * 0.15; // 15% VAT
        const total = subtotal + tax;

        container.innerHTML = `
        <div class="bg-white p-8 rounded-lg shadow-lg border-2 border-gray-200">
          <div class="flex justify-between items-start mb-8 pb-6 border-b-2" style="border-color: ${
            branding.primaryColor
          }">
            <div class="flex items-center gap-4">
              ${
                branding.logo
                  ? `<img src="${branding.logo}" alt="Logo" class="h-16 w-16 object-contain" />`
                  : ""
              }
              <div>
                <h1 class="text-4xl font-bold mb-1" style="color: ${
                  branding.primaryColor
                }">INVOICE</h1>
                <p class="text-gray-600 text-sm">${branding.tagline}</p>
              </div>
            </div>
            <div class="text-right text-sm">
              <p class="font-semibold">#${invoiceData.number}</p>
              <p class="text-gray-600">Date: ${invoiceData.date}</p>
              <p class="text-gray-600">Due: ${invoiceData.dueDate}</p>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-6 mb-8 text-sm">
            <div>
              <h3 class="font-semibold mb-2" style="color: ${
                branding.primaryColor
              }">FROM</h3>
              <p class="font-semibold">${invoiceData.from.name}</p>
              <p class="text-gray-600">${invoiceData.from.address}</p>
              <p class="text-gray-600">${invoiceData.from.city}</p>
              <p class="text-gray-600">${invoiceData.from.email}</p>
              <p class="text-gray-600">${invoiceData.from.phone}</p>
            </div>
            <div>
              <h3 class="font-semibold mb-2" style="color: ${
                branding.primaryColor
              }">TO</h3>
              <p class="font-semibold">${invoiceData.to.name}</p>
              <p class="text-gray-600">${invoiceData.to.address}</p>
              <p class="text-gray-600">${invoiceData.to.city}</p>
              <p class="text-gray-600">${invoiceData.to.email || ""}</p>
              <p class="text-gray-600">${invoiceData.to.phone || ""}</p>
            </div>
          </div>

          ${
            invoiceData.vehicle
              ? `
          <div class="mb-8 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-semibold mb-3" style="color: ${
              branding.primaryColor
            }">VEHICLE DETAILS</h3>
            <div class="grid grid-cols-3 gap-4 text-sm">
              <div>
                <span class="text-gray-600">Registration:</span>
                <span class="ml-2 font-medium">${
                  invoiceData.vehicle.registration
                }</span>
              </div>
              <div>
                <span class="text-gray-600">Make:</span>
                <span class="ml-2 font-medium">${
                  invoiceData.vehicle.make
                }</span>
              </div>
              <div>
                <span class="text-gray-600">Model:</span>
                <span class="ml-2 font-medium">${
                  invoiceData.vehicle.model
                }</span>
              </div>
              ${
                invoiceData.vehicle.year
                  ? `
              <div>
                <span class="text-gray-600">Year:</span>
                <span class="ml-2 font-medium">${invoiceData.vehicle.year}</span>
              </div>`
                  : ""
              }
              ${
                invoiceData.vehicle.vin
                  ? `
              <div>
                <span class="text-gray-600">VIN:</span>
                <span class="ml-2 font-medium">${invoiceData.vehicle.vin}</span>
              </div>`
                  : ""
              }
              ${
                invoiceData.vehicle.odometer
                  ? `
              <div>
                <span class="text-gray-600">Odometer:</span>
                <span class="ml-2 font-medium">${invoiceData.vehicle.odometer}</span>
              </div>`
                  : ""
              }
            </div>
          </div>
          `
              : ""
          }

          <table class="w-full mb-8">
            <thead>
              <tr class="border-b-2" style="border-color: ${
                branding.primaryColor
              }">
                <th class="text-left py-3 text-sm font-semibold">Description</th>
                <th class="text-right py-3 text-sm font-semibold">Qty</th>
                <th class="text-right py-3 text-sm font-semibold">Rate</th>
                <th class="text-right py-3 text-sm font-semibold">Amount</th>
              </tr>
            </thead>
            <tbody>
              ${invoiceData.items
                .map(
                  (item) => `
                <tr class="border-b border-gray-200">
                  <td class="py-3 text-sm">${item.description}</td>
                  <td class="text-right py-3 text-sm">${item.quantity}</td>
                  <td class="text-right py-3 text-sm">R ${item.rate.toFixed(
                    2
                  )}</td>
                  <td class="text-right py-3 text-sm font-semibold">R ${item.amount.toFixed(
                    2
                  )}</td>
                </tr>
              `
                )
                .join("")}
            </tbody>
          </table>

          <div class="flex justify-end mb-8">
            <div class="w-72">
              <div class="flex justify-between py-2 text-sm">
                <span class="text-gray-600">Subtotal:</span>
                <span class="font-medium">R ${subtotal.toFixed(2)}</span>
              </div>
              <div class="flex justify-between py-2 text-sm">
                <span class="text-gray-600">Tax (15%):</span>
                <span class="font-medium">R ${tax.toFixed(2)}</span>
              </div>
              <div class="flex justify-between py-3 border-t-2 mt-2 font-bold text-xl" 
                   style="border-color: ${branding.primaryColor}; color: ${
          branding.primaryColor
        }">
                <span>Total:</span>
                <span>R ${total.toFixed(2)}</span>
              </div>
            </div>
          </div>

          ${
            invoiceData.notes
              ? `
          <div class="mt-6 p-4 bg-gray-50 rounded">
            <p class="text-sm text-gray-600">${invoiceData.notes}</p>
          </div>
          `
              : ""
          }
        </div>
      `;
      }

      // ========================================
      // 5. AUTHENTICATION & INITIALIZATION
      // ========================================
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;

          // Fetch user's name from Firestore
          try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            const userName = userDoc.exists()
              ? userDoc.data().name
              : user.email || user.uid.substring(0, 8) + "...";
            document.getElementById(
              "authStatus"
            ).textContent = `Authenticated as: ${userName}`;
          } catch (error) {
            console.error("Error fetching user name:", error);
            document.getElementById(
              "authStatus"
            ).textContent = `Authenticated as: ${
              user.email || user.uid.substring(0, 8) + "..."
            }`;
          }

          loadTemplates();
          renderInvoicePreview();
        } else {
          // Sign in anonymously if not authenticated
          signInAnonymously(auth).catch((error) => {
            console.error("Authentication error:", error);
            showMessage("Authentication failed: " + error.message, "error");
          });
        }
      });

      // Make functions available globally
      window.loadTemplate = loadTemplate;
      window.updateTemplate = updateTemplate;
      window.deleteTemplate = deleteTemplate;
      window.saveCurrentAsTemplate = saveCurrentAsTemplate;
      window.loadTemplates = loadTemplates;
    </script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-6 max-w-7xl">
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h1 class="text-3xl font-bold mb-2">Invoice Template Manager</h1>
        <p id="authStatus" class="text-sm text-gray-600 mb-4">
          Authenticating...
        </p>

        <!-- Message Area -->
        <div id="message" style="display: none"></div>

        <!-- Loader -->
        <div id="loader" style="display: none" class="text-center py-4">
          <div
            class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
          ></div>
          <p class="text-sm text-gray-600 mt-2">Loading...</p>
        </div>
      </div>

      <!-- Save Template Section -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4">Current Template</h2>
        <p class="text-sm text-gray-600 mb-4">
          Save the current invoice preview as a reusable template
        </p>
        <button
          onclick="window.saveCurrentAsTemplate()"
          class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 font-semibold transition-colors"
        >
          ðŸ’¾ Save Current as Template
        </button>
      </div>

      <!-- Saved Templates List -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold">Your Saved Templates</h2>
          <button
            onclick="window.loadTemplates()"
            class="text-blue-600 hover:text-blue-800 text-sm"
          >
            ðŸ”„ Refresh
          </button>
        </div>
        <div
          id="templatesList"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        >
          <p class="text-gray-500">Loading templates...</p>
        </div>
      </div>

      <!-- Invoice Preview -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4">Invoice Preview</h2>
        <div id="invoicePreview"></div>
      </div>
    </div>
  </body>
</html>
